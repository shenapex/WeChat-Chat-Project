åŸæ–‡å‘è¡¨äºï¼ˆå·²åˆ é™¤ï¼‰ï¼šhttps://blog.lc044.love/post/13

> è€—æ—¶4ä¸ªæœˆæˆ‘æŠŠå¾®ä¿¡ç ”ç©¶äº†ä¸ªéï¼Œä»¥ä¸‹å†…å®¹ä»…ä»£è¡¨ä¸ªäººç»éªŒæˆ–çŒœæƒ³ï¼Œè½¬è½½è¯·æ³¨æ˜å‡ºå¤„ã€‚

## ä¸€ã€ğŸ’¡ å¼•è¨€

------

å‰è¨€

æˆ‘æ·±ä¿¡æœ‰æ„ä¹‰çš„ä¸æ˜¯å¾®ä¿¡ï¼Œè€Œæ˜¯éšè—åœ¨å¯¹è¯æ¡†èƒŒåçš„ä¸€ä¸ªä¸ª**æ·±åˆ»æ•…äº‹**ã€‚æœªæ¥ï¼Œæ¯ä¸ªäººéƒ½èƒ½æ‹¥æœ‰AIçš„é™ªä¼´ï¼Œè€Œä½ çš„æ•°æ®èƒ½å¤Ÿèµ‹äºˆå®ƒæœ‰å…³äºä½ è¿‡å»çš„çè´µè®°å¿†ã€‚æˆ‘å¸Œæœ›æ¯ä¸ªäººéƒ½æœ‰å°†è‡ªå·±çš„ç”Ÿæ´»ç—•è¿¹ğŸ‘¨â€ğŸ‘©â€ğŸ‘¦ğŸ‘šğŸ¥—ğŸ ï¸ğŸš´ğŸ§‹â›¹ï¸ğŸ›ŒğŸ›€ç•™å­˜çš„æƒåˆ©ï¼Œè€Œä¸æ˜¯é—å¿˜ğŸ’€ã€‚

AIçš„å‘å±•ä¸ä»…ä»…æ˜¯æŠ€æœ¯çš„æå‡ï¼Œæ›´æ˜¯æƒ…æ„ŸğŸ’çš„å»¶ç»­ã€‚æ¯ä¸€ä¸ªå¯¹è¯ã€æ¯ä¸€ä¸ªäº’åŠ¨éƒ½æ˜¯ç”Ÿæ´»ä¸­ç‹¬ä¸€æ— äºŒçš„ç‰‡æ®µï¼Œæ˜¯çœŸå®è€ŒåŠ¨äººçš„æƒ…æ„Ÿäº¤æµã€‚å› æ­¤ï¼Œæˆ‘å¸Œæœ›AIå·¥ä½œè€…ä»¬èƒ½å¤Ÿ**å–„ç”¨è¿™äº›è‡ªå·±çš„æ•°æ®**ï¼Œç”¨äºåŸ¹è®­ç‹¬ç‰¹çš„ã€å±äºä¸ªä½“çš„äººå·¥æ™ºèƒ½ã€‚è®©**ä¸ªäººAIæˆä¸ºç”Ÿæ´»ä¸­çš„æœ‹å‹**ï¼Œèƒ½å¤Ÿç†è§£ã€è®°å½•å¹¶åˆ†äº«æˆ‘ä»¬çš„æ¬¢ç¬‘ã€æ³ªæ°´å’Œæˆé•¿ã€‚

é‚£å¤©ï¼ŒAIä¸å†æ˜¯é«˜ä¸å¯æ”€çš„å­˜åœ¨ï¼Œè€Œæ˜¯èå…¥å¯»å¸¸ç™¾å§“å®¶çš„ä¸€éƒ¨åˆ†ã€‚å› ä¸º**æ¯ä¸ªäººèƒ½æ‹¥æœ‰è‡ªå·±çš„AI**ï¼Œå°†ç§‘æŠ€çš„åŠ›é‡èå…¥ç”Ÿæ´»çš„æ–¹æ–¹é¢é¢ã€‚è¿™æ˜¯ä¸€åœºå…³äºçœŸæƒ…å®æ„Ÿçš„é©å‘½ï¼Œä¸€åœºè®©æŠ€æœ¯å˜å¾—æ›´åŠ äººæ€§åŒ–çš„æ¢ç´¢ï¼Œè®©æˆ‘ä»¬å…±åŒè§è¯æœªæ¥çš„ç¾å¥½ã€‚

**æ‰€ä»¥ã€Šç•™ç—•ã€‹**

[![img](https://blog.lc044.love/static/img/91cadaae3a6f7ee133dafd4f9b5d8680.logo.webp)](https://memotrace.cn/)

------

## äºŒã€âœ¨ åŠŸèƒ½ç‰¹ç‚¹

> **MemoTrace** æ”¯æŒ**è§£æ**ã€**å¯¼å‡º**ã€**åˆ†æ**ä¸‰å¤§åŠŸèƒ½ï¼Œæ”¯æŒå¾®ä¿¡3å’Œå¾®ä¿¡4å…¨ç‰ˆæœ¬ï¼Œæ”¯æŒå¯¼å‡ºå¤šç§æ ¼å¼çš„èŠå¤©è®°å½•ã€æ”¯æŒå¯¼å‡ºå‡ ä¹å…¨éƒ¨ç±»å‹çš„æ¶ˆæ¯ç±»å‹ï¼Œæ—¢æœ‰é€‚åˆå¼€å‘è€…äºŒæ¬¡å¼€å‘çš„åç«¯æ¥å£åˆæœ‰é€‚äºå°ç™½ç”¨æˆ·ä½¿ç”¨çš„ç•Œé¢åº”ç”¨ç¨‹åºã€‚

- æ”¯æŒWindowså¾®ä¿¡3.xå’Œå¾®ä¿¡4.0

- è·å–æ‰‹æœºå·ã€å¾®ä¿¡æ˜µç§°ã€wxid

- è§£æå¾®ä¿¡èŠå¤©è®°å½•æ•°æ®åº“

- å¢é‡è§£æå¾®ä¿¡èŠå¤©è®°å½•æ•°æ®åº“

- **å¯¼å‡ºèŠå¤©è®°å½•**

  - å¯¼å‡ºè”ç³»äºº
    - å¾®ä¿¡å·ã€æ˜µç§°ã€å¤‡æ³¨ã€æ€§åˆ«ã€åœ°åŒºã€ç­¾åã€æ ‡ç­¾ã€ç”µè¯
  - å¯¼å‡ºHTML
    - æ”¯æŒçš„æ¶ˆæ¯ç±»å‹ï¼šæ–‡æœ¬ã€å›¾ç‰‡ã€è¡¨æƒ…åŒ…ã€è§†é¢‘ã€è½¬è´¦ã€åˆ†äº«çš„å¡ç‰‡é“¾æ¥ã€è¯­éŸ³ã€è½¬è´¦ã€éŸ³è§†é¢‘é€šè¯è®°å½•ã€åˆå¹¶è½¬å‘çš„èŠå¤©è®°å½•ã€å¼•ç”¨æ¶ˆæ¯ã€åç‰‡åˆ†äº«ã€å°ç¨‹åºã€è§†é¢‘å·ã€æ‹ä¸€æ‹ç­‰ç³»ç»Ÿæ¶ˆæ¯
    - æ”¯æŒæ—¶é—´è½´è·³è½¬
    - æ”¯æŒæ—¥æœŸè·³è½¬
    - é“¾æ¥æ”¯æŒè·³è½¬åˆ°åŸæ–‡
    - å¼•ç”¨æ¶ˆæ¯æ”¯æŒå®šä½åˆ°åŸæ–‡
  - å¯¼å‡ºTXT
  - å¯¼å‡ºdocx
  - å¯¼å‡ºcsv
  - å¯¼å‡ºExcel(xlsx)
    - å­—æ®µï¼šæ¶ˆæ¯IDã€ç±»å‹ã€å‘é€äººã€å†…å®¹ã€å¤‡æ³¨ã€æ˜µç§°
    - æ”¯æŒçš„æ¶ˆæ¯ç±»å‹
      - æ–‡æœ¬ã€å›¾ç‰‡ã€ä½ç½®åˆ†äº«ã€åˆ†äº«çš„å¡ç‰‡é“¾æ¥ã€å¼•ç”¨æ¶ˆæ¯ã€åç‰‡åˆ†äº«ã€è½¬è´¦ã€éŸ³è§†é¢‘é€šè¯è®°å½•ã€å°ç¨‹åºã€è§†é¢‘å·ã€æ‹ä¸€æ‹ç­‰ç³»ç»Ÿæ¶ˆæ¯
      - è¯­éŸ³ã€è§†é¢‘ã€æ–‡ä»¶éƒ½æ˜¯ä»¥è¶…é“¾æ¥çš„å½¢å¼åŠ åˆ°å†…å®¹é‡Œï¼Œå›¾ç‰‡åµŒå…¥åˆ°å•å…ƒæ ¼é‡Œ

  - æ‰¹é‡å¯¼å‡ºèŠå¤©è®°å½•
  - å¯¼å‡ºè·Ÿä¼ä¸šå¾®ä¿¡è”ç³»äººçš„èŠå¤©è®°å½•
  - å¯¼å‡ºJSONï¼ˆç”¨äºè®­ç»ƒAIï¼‰
    - æ”¯æŒAlpacaã€GLM3ã€GLM4æ ¼å¼çš„å¤šè½®å¯¹è¯æ•°æ®é›†
  - å¯¼å‡ºmarkdownæ ¼å¼
  - å¯¼å‡ºç¾¤æˆå‘˜ä¿¡æ¯ï¼ˆå¾®ä¿¡å·ã€æ˜µç§°ã€å¤‡æ³¨ã€æ€§åˆ«ã€åœ°åŒºï¼‰
  - å¯¼å‡ºå…¬ä¼—å·æ–‡ç« é“¾æ¥
    - æ”¯æŒå¯¼å‡ºæ ¼å¼ï¼šHTMLã€Excel(xlsx)ï¼ˆä»…ä¼šå‘˜å¯ç”¨ï¼‰ã€TXT

- **å¹´åº¦èŠå¤©æŠ¥å‘Š**

  - å¹´åº¦èŠå¤©å¥½å‹
  - å¹´åº¦å…³é”®è¯
  - åŒäººå¹´åº¦èŠå¤©æŠ¥å‘Š
  - AIåˆ†æ

- **ç»Ÿè®¡æ•°æ®**

  - èŠå¤©ç»Ÿè®¡å›¾
  - æ¶ˆæ¯æ•°é‡åˆ†å¸ƒé¥¼å›¾
  - æ˜ŸæœŸåˆ†å¸ƒå›¾

------

**åé¢å†…å®¹ä¾›å­¦ä¹ ä½¿ç”¨ï¼Œä¸ºé¿å…å¤´ç–¼ï¼Œæ™®é€šç”¨æˆ·è¯·è½¬è‡³å®˜ç½‘ [memotrace.cn](https://memotrace.cn/) ä¸‹è½½ä½¿ç”¨**

## ä¸‰ã€â›ï¸ å¾®ä¿¡åˆ†æ

### 3.1 å¾®ä¿¡æ•°æ®åº“ç›®å½•ç»“æ„

#### 3.1.1 å¾®ä¿¡3

å¾®ä¿¡3æ•°æ®åº“ç›®å½•ç»“æ„

```bash
text
â”œâ”€Msg
â”‚  â”‚  Applet.db             # å°ç¨‹åº
â”‚  â”‚  BizChat.db            # 
â”‚  â”‚  BizChatMsg.db
â”‚  â”‚  ChatMsg.db
â”‚  â”‚  ChatRoomUser.db
â”‚  â”‚  ClientGeneral.db
â”‚  â”‚  CustomerService.db
â”‚  â”‚  Emotion.db            # è¡¨æƒ…åŒ…
â”‚  â”‚  Favorite.db           # å¾®ä¿¡æ”¶è—
â”‚  â”‚  FTSContact.db         # æœç´¢è”ç³»äºº
â”‚  â”‚  FTSFavorite.db        # æœç´¢æ”¶è—
â”‚  â”‚  FunctionMsg.db
â”‚  â”‚  HardLinkFile.db       # å¾®ä¿¡æ–‡ä»¶
â”‚  â”‚  HardLinkImage.db      # å¾®ä¿¡å›¾ç‰‡
â”‚  â”‚  HardLinkVideo.db      # å¾®ä¿¡è§†é¢‘
â”‚  â”‚  ImageTranslate.db
â”‚  â”‚  LinkHistory.db
â”‚  â”‚  MicroMsg.db           # å¾®ä¿¡è”ç³»äºº
â”‚  â”‚  Misc.db               # å¾®ä¿¡è”ç³»äººå¤´åƒ
â”‚  â”‚  MultiSearchChatMsg.db
â”‚  â”‚  NewTips.db
â”‚  â”‚  OpenIMContact.db      # ä¼ä¸šå¾®ä¿¡è”ç³»äºº
â”‚  â”‚  OpenIMMedia.db        # ä¼ä¸šå¾®ä¿¡è¯­éŸ³
â”‚  â”‚  OpenIMMsg.db          # ä¼ä¸šå¾®ä¿¡èŠå¤©è®°å½•
â”‚  â”‚  OpenIMResource.db     # ä¼ä¸šå¾®ä¿¡è”ç³»äººå…¬å¸ä¿¡æ¯
â”‚  â”‚  PreDownload.db        
â”‚  â”‚  PublicMsg.db          # å…¬ä¼—å·æ¶ˆæ¯
â”‚  â”‚  PublicMsgMedia.db     # å…¬ä¼—å·è¯­éŸ³æ¶ˆæ¯
â”‚  â”‚  Sns.db                # æœ‹å‹åœˆæ•°æ®
â”‚  â”‚  StoreEmotion.db
â”‚  â”‚  SyncMsg.db
â”‚  â”‚  Voip.db
â”‚  â””â”€Multi                  # Multiæ–‡ä»¶å¤¹é‡Œçš„æ•°æ®åº“é‡‡ç”¨äº†åˆ†åº“æ“ä½œï¼Œå°†ä¸€ä¸ªå¤§æ•°æ®åº“åˆ†æˆå¤šä¸ªä¾¿äºæé«˜æ£€ç´¢æ•ˆç‡
â”‚          FTSMSG0.db       # æœç´¢èŠå¤©è®°å½•
â”‚          FTSMSG1.db
â”‚          MediaMSG0.db     # è¯­éŸ³æ¶ˆæ¯ 0
â”‚          MediaMSG1.db     # è¯­éŸ³æ¶ˆæ¯ 1
â”‚          MSG0.db          # èŠå¤©è®°å½• 0
â”‚          MSG1.db          # èŠå¤©è®°å½• 1
```

**Bash**

#### 3.1.2 å¾®ä¿¡4

å¾®ä¿¡4æ•°æ®åº“ç›®å½•ç»“æ„

```bash
text
â”œâ”€db_storage
â”‚  â”‚  
â”‚  â”œâ”€biz
â”‚  â”‚      biz.db                
â”‚  â”œâ”€contact                    # è”ç³»äºº
â”‚  â”‚      contact.db
â”‚  â”‚      contact_fts.db
â”‚  â”‚      fmessage_new.db
â”‚  â”‚      wa_contact_new.db
â”‚  â”œâ”€emoticon                   # è¡¨æƒ…åŒ…
â”‚  â”‚      emoticon.db
â”‚  â”œâ”€favorite                   # å¾®ä¿¡æ”¶è—
â”‚  â”‚      favorite.db
â”‚  â”‚      favorite_fts.db
â”‚  â”œâ”€hardlink                   # å¾®ä¿¡å›¾ç‰‡ã€è§†é¢‘ã€æ–‡ä»¶
â”‚  â”‚      hardlink.db
â”‚  â”œâ”€head_image                 # å¾®ä¿¡å¤´åƒ
â”‚  â”‚      head_image.db
â”‚  â”œâ”€ilinkvoip
â”‚  â”‚      ilinkvoip.db
â”‚  â”œâ”€message                    # èŠå¤©è®°å½•
â”‚  â”‚      biz_message_0.db      # å…¬ä¼—å·æ¶ˆæ¯
â”‚  â”‚      media_0.db            # è¯­éŸ³æ¶ˆæ¯
â”‚  â”‚      message_0.db          # èŠå¤©è®°å½•
â”‚  â”‚      message_1.db
â”‚  â”‚      message_fts.db
â”‚  â”‚      message_resource.db
â”‚  â”‚      message_revoke.db
â”‚  â”œâ”€newtips
â”‚  â”‚      newtips.db
â”‚  â”œâ”€session                    # èŠå¤©ä¼šè¯çª—å£
â”‚  â”‚      session.db
â”‚  â”œâ”€sns                        # æœ‹å‹åœˆ
â”‚  â”‚      sns.db
â”‚  â”œâ”€teenager
â”‚  â”‚      teenager.db
â”‚  â”œâ”€tencentpay
â”‚  â”‚      tencentpay.db
â”‚  â”œâ”€wcfinder
â”‚  â”‚      wcfinder.db
â”‚  â””â”€websearch
â”‚          websearch.db
```

**Bash**

#### 3.1.3 æ•°æ®åº“ç»“æ„è¯´æ˜

ä¸ç®¡æ˜¯å¾®ä¿¡3è¿˜æ˜¯å¾®ä¿¡4ï¼ŒèŠå¤©æ•°æ®ã€å›¾ç‰‡ã€è§†é¢‘ã€æ–‡ä»¶ã€è¡¨æƒ…åŒ…ã€è¯­éŸ³éƒ½æ˜¯å­˜å‚¨åœ¨ä¸åŒçš„æ•°æ®åº“ä¸­çš„ï¼Œå› æ­¤è§£æä¸€æ¡èŠå¤©è®°å½•è¦ç»¼åˆæŸ¥è¯¢å¤šä¸ªæ•°æ®åº“çš„å†…å®¹ã€‚

ä¸ºäº†é¿å…è·¨æ•°æ®åº“è¿æ¥æ“ä½œï¼Œ**MemoTrace**ä¸ºæ¯ä¸ªæ•°æ®åº“éƒ½å»ºç«‹ä¸€ä¸ªè¿æ¥ï¼Œå„æ•°æ®åº“ä¹‹é—´äº’ç›¸ä¸äº§ç”Ÿä¾èµ–ï¼Œç”±ä¸Šå±‚æ¨¡å—ç»¼åˆè°ƒç”¨å„ä¸ªæ•°æ®åº“ï¼Œç»„è£…å‡ºæ¯ä¸€æ¡å®Œæ•´çš„æ•°æ®ã€‚

å¾®ä¿¡3å’Œå¾®ä¿¡4çš„æ•°æ®åº“ä¸å°½ç›¸åŒï¼Œéƒ¨åˆ†æ•°æ®åº“å­—æ®µæœ‰å¾ˆå¤§è°ƒæ•´ï¼Œæ‰€ä»¥**MemoTrace**æŠŠv3å’Œv4åˆ†æˆç‹¬ç«‹çš„ä¸¤ä¸ªéƒ¨åˆ†ï¼ŒæŠŠv3å’Œv4çš„èŠå¤©è®°å½•(`Message`)å’Œè”ç³»äºº(`Contact`)æŠ½è±¡å¾—å‡ºç›¸åŒçš„ä¸€ä¸ªæ•°æ®ç»“æ„ï¼Œé€šè¿‡`ManagerV3`å’Œ`ManagerV4`å®ç°ä¸åŒæ•°æ®åº“æ¨¡å—çš„åˆ†å¸ƒç®¡ç†å’Œæ‰©å±•ï¼Œé€šè¿‡`DataBaseInterface`å±‚å¯¹å¤–æä¾›ç»Ÿä¸€æ¥å£ï¼Œéš”ç¦»å†…éƒ¨å®ç°ã€‚

è¯¦ç»†è®¾è®¡å°†åœ¨åé¢ç»™å‡ºã€‚

![æ•°æ®åº“æ¨¡å—æ¶æ„](https://blog.lc044.love/static/img/0fbb4eafa332f2a77d912ffa9c72f0bd.image.webp)

### 3.2 å¾®ä¿¡éƒ¨åˆ†æ•°æ®è§£æ

#### 3.2.1 å¾®ä¿¡å›¾ç‰‡åŠ å¯†æ–¹å¼

**å¾®ä¿¡3**

> å¾®ä¿¡4.0ä¹‹å‰çš„å›¾ç‰‡éƒ½é‡‡ç”¨äº†æœ€ç®€å•çš„å¼‚æˆ–åŠ å¯†ï¼Œå³é‡‡ç”¨ä¸€ä¸ªå¼‚æˆ–å¯†é’¥ï¼ˆä¸€ä¸ª0-255çš„æ•´æ•°ï¼‰ä¸å›¾ç‰‡æ–‡ä»¶çš„æ¯ä¸ªå­—èŠ‚è¿›è¡Œå¼‚æˆ–è¿ç®—ã€‚ç”±äºå¼‚æˆ–è¿ç®—å…·æœ‰å¯é€†æ€§ï¼Œé‡‡ç”¨ç›¸åŒçš„å¯†é’¥å†åšä¸€æ¬¡å¼‚æˆ–è¿ç®—å³å¯å¾—åˆ°åŸå§‹å›¾ç‰‡æ–‡ä»¶ã€‚

**å¼‚æˆ–è¿ç®—æ€§è´¨**

1. äº¤æ¢å¾‹ï¼š A ^ B = B ^ A
2. ç»“åˆå¾‹ï¼š ( A ^ B ) ^ C = A ^ ( B ^ C )
3. è‡ªåæ€§ï¼š A ^ B ^ B = A

å‡è®¾ï¼š

- åŠ å¯†åæ•°æ®ï¼š`C`
- å·²çŸ¥çš„åŸå§‹æ–‡ä»¶å¤´ï¼ˆMagic Numberï¼‰ï¼š`P`
- å¯†é’¥ï¼š`K`
- å¯†é’¥é•¿åº¦ï¼š`L`
- ç¬¬ `i` ä¸ªå­—èŠ‚ï¼š`i`

ä¸åŒæ ¼å¼çš„å›¾ç‰‡é€šå¸¸æœ‰å›ºå®šçš„æ–‡ä»¶å¤´ï¼Œä¾‹å¦‚ï¼š

- **PNG**: `89 50 4E 47 0D 0A 1A 0A`
- **JPG**: `FF D8 FF E0` æˆ– `FF D8 FF DB`
- **BMP**: `42 4D`
- **GIF**: `47 49 46 38 39 61` æˆ– `47 49 46 38 37 61`

æ ¹æ®å¼‚æˆ–è¿ç®—çš„æ€§è´¨ï¼š

Ci=PiâŠ•Ki

å¯å¾—ï¼š

Ki=CiâŠ•Pi

æ‰€ä»¥ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å·²çŸ¥çš„åŠ å¯†æ•°æ® `C` å’Œå·²çŸ¥çš„æ–‡ä»¶å¤´ `P` è®¡ç®—å¯†é’¥çš„å‰ `L` ä¸ªå­—èŠ‚ï¼š

K0=C0âŠ•P0

K1=C1âŠ•P1

...

KLâˆ’1=CLâˆ’1âŠ•PLâˆ’1

å¯†é’¥æ˜¯ä¸€ä¸ª0-255èŒƒå›´å†…çš„æ•´æ•°æ‰€ä»¥: key=K0=K1=K2â‹…â‹…â‹…=KLâˆ’1

------

**å¾®ä¿¡4**

> å¾®ä¿¡4çš„å›¾ç‰‡é‡‡ç”¨AES-EBCå’Œå¼‚æˆ–æ··åˆåŠ å¯†æ–¹å¼ã€‚

**.datæ–‡ä»¶å¤´(15ä¸ªå­—èŠ‚)**

| å¤§å°(å­—èŠ‚) | å†…å®¹/ç±»å‹      | è¯´æ˜                |
| ---------- | -------------- | ------------------- |
| 6          | 0x07085631     | .datæ–‡ä»¶æ ‡è¯†ç¬¦      |
| 4          | int ï¼ˆå°ç«¯åºï¼‰ | AES-EBC128 åŠ å¯†é•¿åº¦ |
| 4          | int ï¼ˆå°ç«¯åºï¼‰ | å¼‚æˆ–åŠ å¯†é•¿åº¦        |
| 1          | 0x01           | æœªçŸ¥                |

![datæ–‡ä»¶å¤´](https://blog.lc044.love/static/img/a049d886cbd0e95ca2018ac91843a966.image.webp)

**æ–‡ä»¶æœ«å°¾é‡‡ç”¨å¼‚æˆ–åŠ å¯†ï¼ŒåŠ å¯†é•¿åº¦æœ€å¤§ä¸º1MBï¼Œå¤šä½™éƒ¨åˆ†æœªåŠ å¯†ã€‚**

> ä¾‹å¦‚ï¼šä¸€ä¸ªæ–‡ä»¶å°äº1kBï¼Œåˆ™å…¨éƒ¨æ˜¯AESåŠ å¯†ï¼Œå¦‚æœå¤§äº1kBä¸”å°äº1MBï¼ˆå®é™…æ˜¯1MBé›¶1KBï¼‰ï¼Œåˆ™å‰1KBéƒ¨åˆ†é‡‡ç”¨AESåŠ å¯†ï¼Œå‰©ä½™éƒ¨åˆ†é‡‡ç”¨å¼‚æˆ–åŠ å¯†ã€‚å¦‚æœæ–‡ä»¶å¤§äº1MBï¼Œåˆ™å‰1KBé‡‡ç”¨AESåŠ å¯†ï¼Œåé¢1MBé‡‡ç”¨å¼‚æˆ–åŠ å¯†ï¼Œä¸­é—´éƒ¨åˆ†æœªåŠ å¯†ã€‚

![datæ–‡ä»¶ç»“æ„](https://blog.lc044.love/static/img/403cd0087b1a728b2e73314c414f5a0f.image.webp)

- AES å¯†é’¥ä¸ºï¼š`0xcfcd208495d565ef`
- æ ¹æ®å¼‚æˆ–è¿ç®—çš„å¯é€†æ€§ï¼Œç»“åˆjpgæ–‡ä»¶æœ«å°¾çš„ **FF D9** ä¸¤ä¸ªå­—èŠ‚ï¼Œå¯ä»¥æ‰¾ä¸€å¼ å¾®ä¿¡ç”Ÿæˆçš„ç¼©ç•¥å›¾ï¼ˆä¸€èˆ¬ä¸º_t.datç»“å°¾ï¼‰ï¼Œä¸¤æ¬¡å¼‚æˆ–è¿ç®—å³å¯å¾—åˆ°å¼‚æˆ–å¯†é’¥ã€‚

#### 3.2.2 å¾®ä¿¡æ–‡ä»¶ã€æ–‡ä»¶å¤¹å‘½åè§„åˆ™

**å¾®ä¿¡3**

```bash
text
â”œâ”€Applet
â”œâ”€Backup
â”œâ”€FileStorage       # å­˜å‚¨å¾®ä¿¡å›¾ç‰‡ã€è§†é¢‘ã€æ–‡ä»¶
â”‚  â”œâ”€Cache          # ç¼©ç•¥å›¾ç¼“å­˜
â”‚  â”œâ”€CustomEmotion  # è¡¨æƒ…åŒ…
â”‚  â”œâ”€Fav            # æ”¶è—
â”‚  â”œâ”€File           # å¾®ä¿¡æ–‡ä»¶
â”‚  â”œâ”€MsgAttach      # å¾®ä¿¡é‡Œä¸æ¯ä¸ªäººçš„èŠå¤©æ•°æ®
â”‚  â”‚  â””â”€aefd036248e0d4d0f07900a6239272e4    # è¯¥è”ç³»äººwxidçš„md5åŠ å¯†
â”‚  â”‚      â”œâ”€Image                           # èŠå¤©å›¾ç‰‡
â”‚  â”‚      â”‚  â””â”€2024-10
â”‚  â”‚      â”œâ”€Thumb                           # èŠå¤©ä¸­äº§ç”Ÿçš„ç¼©ç•¥å›¾
â”‚  â”‚      â”‚  â””â”€2024-10
â”‚  â”‚      â”œâ”€File                            # åˆå¹¶è½¬å‘çš„èŠå¤©è®°å½•é‡Œçš„æ–‡ä»¶
â”‚  â”‚      â”‚  â””â”€2024-10
â”‚  â”‚      â””â”€Video                           # åˆå¹¶è½¬å‘çš„èŠå¤©è®°å½•é‡Œçš„è§†é¢‘
â”‚  â”‚          â””â”€2024-10
â”‚  â”œâ”€Sns            # æœ‹å‹åœˆæ•°æ®
â”‚  â”œâ”€Video          # èŠå¤©è§†é¢‘
â”‚  â”‚  â””â”€2025-02
â”‚  â””â”€XEditor
â”œâ”€Msg               # èŠå¤©è®°å½•æ•°æ®åº“
â””â”€ResUpdateV2
```

**Bash**

------

**å¾®ä¿¡4**

```bash
text
â”œâ”€business
â”œâ”€cache             # ç¼“å­˜
â”œâ”€config            # é…ç½®æ–‡ä»¶
â”œâ”€db_storage        # èŠå¤©è®°å½•æ•°æ®åº“
â”œâ”€msg               # ä¸å¥½å‹çš„èŠå¤©æ•°æ®
â”‚  â”œâ”€attach         # å¾®ä¿¡é‡Œä¸æ¯ä¸ªäººçš„èŠå¤©æ•°æ®
â”‚  â”‚  â””â”€aefd036248e0d4d0f07900a6239272e4    # è¯¥è”ç³»äººwxidçš„md5åŠ å¯†
â”‚  â”‚  â”‚  â”œâ”€2022-01                          # æ—¥æœŸ
â”‚  â”‚  â”‚  â”‚  â”œâ”€Img                           # èŠå¤©å›¾ç‰‡
â”‚  â”‚  â”‚  â”‚  â””â”€Rec                           # åˆå¹¶è½¬å‘çš„èŠå¤©è®°å½•æ•°æ®
â”‚  â”‚  â”‚  â”‚      â””â”€2090_136022
â”‚  â”‚  â”‚  â”‚          â””â”€Img
â”‚  â”œâ”€file           # å¾®ä¿¡æ–‡ä»¶
â”‚  â””â”€video          # å¾®ä¿¡è§†é¢‘
â”œâ”€Msg               # èŠå¤©è®°å½•æ•°æ®åº“
â””â”€temp
```

**Bash**

å¾®ä¿¡4çš„æ–‡ä»¶å‘½åæ–¹å¼è·Ÿä¹‹å‰æœ‰äº›å¾®åŒºåˆ«ï¼Œä½†å…¶æ•°æ®å­˜æ”¾æ˜¯ç±»ä¼¼çš„ï¼ˆæ–‡ä»¶ã€è§†é¢‘å•ç‹¬å­˜æ”¾åœ¨ç‹¬ç«‹çš„æ–‡ä»¶å¤¹ä¸­ï¼Œå›¾ç‰‡æŒ‰è”ç³»äººåˆ†ç»„å­˜æ”¾åˆ°ä¸åŒçš„æ–‡ä»¶å¤¹ä¸­ï¼‰

### 3.3 æŠ€æœ¯é€‰å‹ï¼ˆPythonã€SQLiteã€protobufè§£æç­‰ï¼‰

### 3.4 ä¸»è¦ä¾èµ–åº“

## å››ã€ğŸ”­ ç³»ç»Ÿæ¶æ„è®¾è®¡

### 4.1 æ¦‚è¿°

è¯¥ç³»ç»Ÿç”±å¤šä¸ªæ¨¡å—ç»„æˆï¼Œä¸»è¦ç”¨äºç®¡ç†èŠå¤©ä¼šè¯ã€å†å²è®°å½•ã€è”ç³»äººæ ‘ä»¥åŠæ•°æ®å¯¼å‡ºä¸åˆ†æã€‚ç³»ç»Ÿçš„ä¸»è¦ç»„æˆéƒ¨åˆ†åŒ…æ‹¬ **GUI**ï¼ˆç”¨æˆ·ç•Œé¢ï¼‰ã€**wxManager**ï¼ˆå¾®ä¿¡ç®¡ç†å™¨ï¼‰å’Œ **application**ï¼ˆåº”ç”¨å±‚ï¼‰ï¼Œå„ä¸ªéƒ¨åˆ†ååŒå·¥ä½œï¼Œå®ç°èŠå¤©æ•°æ®çš„å­˜å‚¨ã€ç®¡ç†ã€åˆ†æå’Œå¯¼å‡ºã€‚

![ç³»ç»Ÿæ¶æ„å›¾](https://blog.lc044.love/static/img/792544ecbbffc60703a1421b92bf9b6d.image.webp)

### 4.2 è®¾è®¡åŸåˆ™

1. **é¢å‘å¯¹è±¡è®¾è®¡**
   - ç³»ç»Ÿä¸»è¦é‡‡ç”¨é¢å‘å¯¹è±¡ç¼–ç¨‹ï¼ˆOOPï¼‰æ€æƒ³ï¼Œé€šè¿‡æŠ½è±¡ç±»å’Œæ¥å£è®¾è®¡ä¿è¯æ•°æ®ç®¡ç†çš„çµæ´»æ€§ã€‚ä¾‹å¦‚ï¼Œ`DataBaseInterface` ä½œä¸ºæ•°æ®åº“è®¿é—®æ¥å£ï¼Œå¯ä»¥é€‚é…ä¸åŒç‰ˆæœ¬çš„æ•°æ®åº“ã€‚
   - æ•´ä¸ªç³»ç»Ÿé‡‡ç”¨æ¨¡å—åŒ–è®¾è®¡ï¼Œæ¯ä¸ªåŠŸèƒ½å•å…ƒç›¸å¯¹ç‹¬ç«‹ï¼Œå½¼æ­¤ä¹‹é—´é€šè¿‡æ¥å£è¿›è¡Œé€šä¿¡ï¼Œä¾¿äºæ‰©å±•å’Œç»´æŠ¤ã€‚
2. **è®¾è®¡æ¨¡å¼**
   - **ç­–ç•¥æ¨¡å¼**ï¼š`wxManager` é‡‡ç”¨ç­–ç•¥æ¨¡å¼ï¼Œæ ¹æ®ä¸åŒçš„æ•°æ®åº“ç‰ˆæœ¬é€‰æ‹©åˆé€‚çš„ç®¡ç†å™¨ï¼ˆ`ManagerV3` æˆ– `ManagerV4`ï¼‰ã€‚
   - **å¤–è§‚æ¨¡å¼**ï¼šæä¾›ç»Ÿä¸€çš„æ•°æ®è®¿é—®æ¥å£ï¼Œä½¿ `GUI` å’Œ `application` æ— éœ€ç›´æ¥æ“ä½œæ•°æ®åº“ã€‚
3. **æ•°æ®æµä¸é€šä¿¡**
   1. `GUI` å‘é€è¯·æ±‚ç»™ `wxManager`ã€‚
   2. `wxManager` é€šè¿‡æ•°æ®åº“æ¥å£è®¿é—®æ•°æ®ã€‚
   3. `application` è·å– `wxManager` æä¾›çš„æ•°æ®å¹¶è¿›è¡Œå¤„ç†ã€‚
   4. å¤„ç†åçš„æ•°æ®è¿”å›ç»™ `GUI` æˆ–ä»¥æŠ¥å‘Šå½¢å¼å¯¼å‡ºã€‚

### 4.3 ç³»ç»Ÿæ¨¡å—

#### 4.3.1 wxManagerï¼ˆå¾®ä¿¡ç®¡ç†å™¨ï¼‰

wxManager ä½œä¸ºç³»ç»Ÿçš„æ ¸å¿ƒæ•°æ®ç®¡ç†å±‚ï¼Œè´Ÿè´£æ•°æ®çš„å­˜å‚¨ã€æ£€ç´¢å’Œç®¡ç†ã€‚è¯¥æ¨¡å—é‡‡ç”¨ç­–ç•¥æ¨¡å¼å’Œå¤–è§‚æ¨¡å¼ï¼Œä½¿å¾—ä¸åŒç‰ˆæœ¬çš„æ•°æ®ç®¡ç†æ¨¡å—å¯ä»¥ç‹¬ç«‹å®ç°ã€‚

1. **æ•°æ®åº“æ¥å£ï¼ˆDataBaseInterfaceï¼‰**

   è¯¥æ¥å£æä¾›å¯¹æ•°æ®åº“çš„ç»Ÿä¸€è®¿é—®æ–¹æ³•ï¼ŒåŒ…æ‹¬ï¼š

   - `getMessages(params): List[Message]` è·å–èŠå¤©æ¶ˆæ¯ã€‚
   - `getContacts(params)` è·å–è”ç³»äººä¿¡æ¯ã€‚
   - `other()` å…¶ä»–æ•°æ®åº“æ“ä½œã€‚

2. **æ•°æ®ç®¡ç†æ¨¡å—**

   wxManager æ”¯æŒå¤šä¸ªæ•°æ®åº“ç®¡ç†æ¨¡å—ï¼š

   - **ManagerV3**ï¼šè´Ÿè´£ç®¡ç† V3 ç‰ˆæœ¬æ•°æ®åº“ï¼ŒåŒ…å«ä»¥ä¸‹å­æ¨¡å—ï¼š
     - `MicroMsgDB`ï¼šå­˜å‚¨å¾®ä¿¡æ¶ˆæ¯ã€‚
     - `MsgDB`ï¼šå­˜å‚¨æ¶ˆæ¯çš„å…·ä½“ä¿¡æ¯ã€‚
     - å…¶ä»–ç›¸å…³æ•°æ®åº“ã€‚
   - **ManagerV4**ï¼šè´Ÿè´£ç®¡ç† V4 ç‰ˆæœ¬æ•°æ®åº“ï¼ŒåŒ…å«ä»¥ä¸‹å­æ¨¡å—ï¼š
     - `contactDB`ï¼šå­˜å‚¨è”ç³»äººä¿¡æ¯ã€‚
     - `messageDB`ï¼šå­˜å‚¨èŠå¤©æ¶ˆæ¯ã€‚
     - å…¶ä»–ç›¸å…³æ•°æ®åº“ã€‚

#### 4.3.2 **applicationï¼ˆåº”ç”¨å±‚ï¼‰**

åº”ç”¨å±‚æä¾›æ•°æ®å¯¼å‡ºã€ç»Ÿè®¡åˆ†æå’Œå¹´åº¦æŠ¥å‘ŠåŠŸèƒ½ã€‚

1. **æ•°æ®å¯¼å‡º**
   - **HtmlExporter**ï¼šå¯¼å‡ºä¸º HTML æ ¼å¼ã€‚
   - **TxtExporter**ï¼šå¯¼å‡ºä¸ºæ–‡æœ¬æ ¼å¼ã€‚
   - å…¶ä»–æ ¼å¼å¯¼å‡ºåŠŸèƒ½ã€‚
2. **ç»Ÿè®¡åˆ†æ**
   - **wordcloud**ï¼šç”ŸæˆèŠå¤©è¯äº‘ã€‚
   - **chat analysis**ï¼šè¿›è¡ŒèŠå¤©æ•°æ®åˆ†æã€‚
   - å…¶ä»–ç»Ÿè®¡åˆ†æåŠŸèƒ½ã€‚
3. **å¹´åº¦æŠ¥å‘Š**
   - **2024 annual report**ï¼š2024 å¹´åº¦èŠå¤©æ•°æ®æ€»ç»“ã€‚
   - å…¶ä»–å¹´åº¦æ•°æ®æŠ¥å‘Šã€‚

#### 4.3.3 **GUIï¼ˆç”¨æˆ·ç•Œé¢ï¼‰**

GUI è´Ÿè´£æä¾›ç”¨æˆ·äº¤äº’ç•Œé¢ï¼ŒåŒ…æ‹¬ä»¥ä¸‹åŠŸèƒ½æ¨¡å—ï¼š

- **chat sessionï¼ˆèŠå¤©ä¼šè¯ï¼‰**ï¼šæä¾›ä¸èŠå¤©ç›¸å…³çš„å®æ—¶ä¼šè¯åŠŸèƒ½ã€‚
- **chat historyï¼ˆèŠå¤©å†å²ï¼‰**ï¼šæä¾›èŠå¤©è®°å½•æŸ¥è¯¢å’Œç®¡ç†åŠŸèƒ½ã€‚
- **contact treeï¼ˆè”ç³»äººæ ‘ï¼‰**ï¼šæ˜¾ç¤ºè”ç³»äººç»„ç»‡ç»“æ„ã€‚
- **annual reportï¼ˆå¹´åº¦æŠ¥å‘Šï¼‰**ï¼šæä¾›å¹´åº¦èŠå¤©æ•°æ®ç»Ÿè®¡ä¸åˆ†æã€‚
- **exporterï¼ˆæ•°æ®å¯¼å‡ºï¼‰**ï¼šæ”¯æŒå°†èŠå¤©æ•°æ®å¯¼å‡ºä¸ºä¸åŒæ ¼å¼ã€‚

## äº”ã€ğŸ” è¯¦ç»†è®¾è®¡

### 5.1 æ¶ˆæ¯è®¾è®¡

è®¾è®¡æ€è·¯

å¾®ä¿¡èŠå¤©æ¶ˆæ¯çš„ç±»å‹æœ‰å¾ˆå¤šï¼ˆæ–‡æœ¬ã€å›¾ç‰‡ã€è§†é¢‘ã€è¯­éŸ³ã€é“¾æ¥ã€åˆå¹¶è½¬å‘çš„èŠå¤©è®°å½•ç­‰è¿‘äºŒåç§ç±»å‹ï¼‰ï¼Œé™¤äº†æ–‡æœ¬æ¶ˆæ¯ï¼Œå…¶ä»–ç±»å‹åœ¨æ•°æ®åº“é‡ŒåŸºæœ¬éƒ½æ˜¯ä»¥xmlï¼ˆæˆ–è€…å‹ç¼©åçš„xmlï¼‰çš„å½¢å¼å­˜å‚¨çš„ï¼Œæ¯ç§ç±»å‹çš„xmlæ ¼å¼éƒ½ä¸ç›¸åŒï¼Œæ‰€ä»¥è§£ææ–¹å¼ä¹Ÿä¸ç›¸åŒï¼Œæ‰€ä»¥éœ€è¦æœ‰å¤§é‡çš„if-elseæ¥å¤„ç†ä¸åŒçš„ç±»å‹ã€‚ä¸ºäº†é¿å…è¿™ç§éº»çƒ¦ï¼Œ**MemoTrace**é‡‡ç”¨é¢å‘å¯¹è±¡çš„è®¾è®¡åŸåˆ™ï¼Œå¯¹æ¶ˆæ¯è¿›è¡ŒæŠ½è±¡å°è£…ï¼ŒåŸºç±»å®šä¹‰å„ç§æ¶ˆæ¯çš„å…±åŒå±æ€§å’Œæ–¹æ³•ï¼Œç”±å­ç±»é’ˆå¯¹ç‰¹å®šæ¶ˆæ¯ç±»å‹è¿›è¡Œå•ç‹¬å¤„ç†ã€‚

#### 5.1.1 è®¾è®¡ç›®æ ‡

1. **ç»Ÿä¸€æ¥å£**ï¼šæä¾›ç»Ÿä¸€çš„æ¶ˆæ¯å¤„ç†æ¥å£ï¼ˆå¦‚ `to_text` å’Œ `to_json`ï¼‰ã€‚
2. **å¯æ‰©å±•æ€§**ï¼šæ”¯æŒé€šè¿‡ç»§æ‰¿æ·»åŠ æ–°æ¶ˆæ¯ç±»å‹ã€‚
3. **ç±»å‹å®‰å…¨**ï¼šåˆ©ç”¨ `@dataclass` æä¾›å­—æ®µéªŒè¯å’Œç±»å‹æç¤ºã€‚
4. **å¤šæ ·åŒ–å±•ç¤º**ï¼šæ”¯æŒæ¶ˆæ¯çš„å¤šç§å±•ç¤ºå½¢å¼ï¼ˆæ–‡æœ¬ã€JSONï¼‰ã€‚
5. **é«˜æ•ˆæ’åº**ï¼šå®ç°åŸºäº `sort_seq` çš„æ¶ˆæ¯æ’åºåŠŸèƒ½ã€‚

![æ¶ˆæ¯ç±»å›¾](https://blog.lc044.love/static/img/845410b1afca816e20ccdad162094b76.image.webp)

#### **5.1.2 æ ¸å¿ƒç±»ï¼š`Message`**

`Message` æ˜¯æ‰€æœ‰æ¶ˆæ¯ç±»å‹çš„åŸºç±»ï¼Œå®šä¹‰äº†æ¶ˆæ¯çš„åŸºæœ¬å±æ€§å’Œæ–¹æ³•ã€‚å­ç±»é€šè¿‡ç»§æ‰¿å¹¶æ‰©å±•æ­¤ç±»ï¼Œæ·»åŠ å„è‡ªç‰¹æœ‰çš„åŠŸèƒ½å’Œæ•°æ®ã€‚

**å±æ€§ï¼š**

Messageå±æ€§æè¿°

- **local_id**: æ¶ˆæ¯çš„æœ¬åœ° IDï¼Œç”¨äºæ ‡è¯†æ¶ˆæ¯çš„æœ¬åœ°å­˜å‚¨ã€‚
- **server_id**: æ¶ˆæ¯çš„å”¯ä¸€ IDï¼Œç”¨äºå…¨å±€å”¯ä¸€æ ‡è¯†æ¶ˆæ¯ã€‚
- **sort_seq**: ç”¨äºæ’åºçš„æ ‡è¯†ç¬¦ã€‚
- **timestamp**: æ¶ˆæ¯çš„å‘é€æ—¶é—´ï¼ˆç§’çº§æ—¶é—´æˆ³ï¼‰ã€‚
- **str_time**: æ ¼å¼åŒ–åçš„æ—¶é—´å­—ç¬¦ä¸²ï¼ˆä¾‹å¦‚ï¼š`2024-12-01 12:00:00`ï¼‰ã€‚
- **type**: æ¶ˆæ¯ç±»å‹ï¼ŒåŸºäº `MessageType` æšä¸¾ï¼ˆå¦‚æ–‡æœ¬ã€å›¾ç‰‡ã€è§†é¢‘ç­‰ï¼‰ã€‚
- **talker_id**: èŠå¤©å¯¹è±¡çš„å”¯ä¸€æ ‡è¯†ï¼ˆä¾‹å¦‚å¥½å‹çš„ wxid æˆ–ç¾¤èŠçš„ wxidï¼‰ã€‚
- **is_sender**: å¸ƒå°”å€¼ï¼Œæ ‡è¯†å½“å‰ç”¨æˆ·æ˜¯å¦ä¸ºæ¶ˆæ¯å‘é€è€…ã€‚
- **sender_id**: æ¶ˆæ¯å‘é€è€…çš„å”¯ä¸€ IDã€‚
- **display_name**: æ¶ˆæ¯å‘é€è€…çš„æ˜¾ç¤ºæ˜µç§°ï¼ˆå¯ä»¥æ˜¯å¤‡æ³¨åæˆ–ç¾¤æ˜µç§°ï¼‰ã€‚
- **avatar_src**: æ¶ˆæ¯å‘é€è€…å¤´åƒçš„èµ„æºè·¯å¾„æˆ– URLã€‚
- **status**: æ¶ˆæ¯çš„çŠ¶æ€æ ‡è¯†ï¼ˆä¾‹å¦‚å·²å‘é€ã€å·²è¯»ç­‰ï¼‰ã€‚
- **xml_content**: æ¶ˆæ¯çš„ XML æ ¼å¼æ•°æ®ã€‚

**æ–¹æ³•ï¼š**

1. **`is_chatroom(self) -> bool`**: åˆ¤æ–­æ¶ˆæ¯æ˜¯å¦æ¥è‡ªç¾¤èŠï¼Œé€šè¿‡ `talker_id` æ˜¯å¦ä»¥ `@chatroom` ç»“å°¾æ¥å®ç°ã€‚
2. **`to_json(self)`**: è½¬æ¢ä¸º JSON æ ¼å¼ï¼ˆéœ€å­ç±»å®ç°ï¼‰ã€‚
3. **`to_text(self)`**: è½¬æ¢ä¸ºçº¯æ–‡æœ¬ï¼ˆéœ€å­ç±»å®ç°ï¼‰ã€‚
4. **`__lt__(self, other)`**: å®šä¹‰æ¶ˆæ¯çš„æ’åºé€»è¾‘ï¼ŒåŸºäº `sort_seq` å±æ€§ã€‚

**ç”¨é€”**ï¼š

- ç»Ÿä¸€å®šä¹‰æ¶ˆæ¯çš„åŸºç¡€å±æ€§ï¼Œä¾¿äºå­ç±»ç»§æ‰¿å’Œæ‰©å±•ã€‚

#### **5.1.2 å­ç±»è®¾è®¡**

ä»¥ä¸‹æ˜¯ä»`Message`ç±»æ´¾ç”Ÿçš„å„ç±»å­ç±»ï¼Œé’ˆå¯¹ä¸åŒçš„æ¶ˆæ¯å†…å®¹æˆ–åŠŸèƒ½è¿›è¡Œè®¾è®¡ã€‚

- **5.1.2.1. `TextMessage`ï¼ˆæ–‡æœ¬ï¼‰**
  - è¡¨ç¤ºçº¯æ–‡æœ¬æ¶ˆæ¯ã€‚
  - ä½œä¸ºæ–‡æœ¬ç›¸å…³æ¶ˆæ¯çš„çˆ¶ç±»ï¼Œè¿›ä¸€æ­¥ç»†åˆ†ä¸ºä»¥ä¸‹å‡ ç±»ï¼š
    - **SystemMessage**ï¼šç³»ç»Ÿç”Ÿæˆçš„æ¶ˆæ¯ï¼ˆå¦‚é€šçŸ¥ç±»æ¶ˆæ¯ï¼‰ã€‚
    - **QuoteMessage**ï¼šå¼•ç”¨å…¶ä»–æ¶ˆæ¯çš„æ–‡æœ¬æ¶ˆæ¯ã€‚
    - **AnnouncementMessage**ï¼šç”¨äºå¹¿æ’­å…¬å‘Šçš„ä¿¡æ¯ã€‚
- **5.1.2.2. `FileMessage`ï¼ˆæ–‡ä»¶ï¼‰**
  - è¡¨ç¤ºåŒ…å«æ–‡ä»¶æˆ–å¤šåª’ä½“å†…å®¹çš„æ¶ˆæ¯ã€‚
  - ä½œä¸ºåª’ä½“ç±»æ¶ˆæ¯çš„çˆ¶ç±»ï¼Œè¿›ä¸€æ­¥ç»†åˆ†ä¸ºä»¥ä¸‹å‡ ç±»ï¼š
    - **ImageMessage**ï¼šå›¾ç‰‡ã€‚
    - **VideoMessage**ï¼šè§†é¢‘ã€‚
    - **VoiceMessage**ï¼šè¯­éŸ³æ¶ˆæ¯ã€‚
    - **EmojiMessage**ï¼šè¡¨æƒ…ç¬¦å·çš„ç‰¹æ®Šåª’ä½“æ¶ˆæ¯ã€‚
- **5.1.2.3. `LinkMessage`ï¼ˆé“¾æ¥ï¼‰**
  - è¡¨ç¤ºåŒ…å«è¶…é“¾æ¥æˆ–å…¶ä»–URLå†…å®¹çš„æ¶ˆæ¯ã€‚
  - ä½œä¸ºé“¾æ¥ç›¸å…³æ¶ˆæ¯çš„çˆ¶ç±»ï¼Œè¿›ä¸€æ­¥ç»†åˆ†ä¸ºä»¥ä¸‹å‡ ç±»ï¼š
    - **ShareCardMessage**ï¼šç”¨äºåˆ†äº«å¡ç‰‡æˆ–æ¨¡æ¿ã€‚
    - **MusicShareMessage**ï¼šç”¨äºåˆ†äº«éŸ³ä¹æˆ–éŸ³é¢‘å†…å®¹ã€‚
    - **AppletMessage**ï¼šç”¨äºåˆ†äº«å°ç¨‹åºæˆ–åµŒå…¥å¼åº”ç”¨ã€‚
    - **MediaMessage**ï¼šç”¨äºåˆ†äº«å¤–éƒ¨åª’ä½“é“¾æ¥ã€‚
- **5.1.2.4. å…¶ä»–ç‰¹æ®Šæ¶ˆæ¯ç±»å‹**ï¼š
  - **MergedMessage**ï¼šåˆå¹¶è½¬å‘çš„èŠå¤©è®°å½•ã€‚
  - **PositionMessage**: åœ°ç†ä½ç½®ä¿¡æ¯ã€‚
  - **TransferMessage**: è½¬è´¦æ¶ˆæ¯ã€‚
  - **RedEnvelopeMessage**: çº¢åŒ…æ¶ˆæ¯ã€‚
  - **BusinessCardMessage**ï¼šè”ç³»äººåç‰‡ã€‚
  - **FavNoteMessage**ï¼šæ”¶è—ç¬”è®°ã€‚
  - **PatMessage**ï¼šæ‹ä¸€æ‹ã€‚
  - **VoipMessage**ï¼šè¯­éŸ³æˆ–è§†é¢‘é€šè¯ç›¸å…³çš„æ¶ˆæ¯ã€‚

#### **5.1.3 ç±»å±‚æ¬¡ç»“æ„**

ç±»å±‚æ¬¡ç»“æ„ä½“ç°äº†æ˜ç¡®çš„èŒè´£åˆ†ç¦»ï¼š

- `Message`æ˜¯æ ¹ç±»ï¼Œæä¾›é€šç”¨çš„å±æ€§å’Œæ–¹æ³•ã€‚
- ä¸“é—¨çš„æ¶ˆæ¯ç±»å‹ï¼ˆå¦‚`TextMessage`ã€`FileMessage`ã€`LinkMessage`ï¼‰æŒ‰åŠŸèƒ½åˆ†ç»„ã€‚
- æ›´ç»†åŒ–çš„å­ç±»ï¼ˆå¦‚`SystemMessage`ã€`ImageMessage`ã€`MusicShareMessage`ï¼‰é’ˆå¯¹ç‰¹å®šæ¶ˆæ¯ç±»å‹æä¾›åŠŸèƒ½ã€‚

### **5.2 æ¶ˆæ¯åˆ›å»º**

ç›¸å…³ä¿¡æ¯

ä¸Šé¢è¯´åˆ°æ¯ç§æ¶ˆæ¯ç±»å‹çš„xmlç»“æ„éƒ½ä¸ç›¸åŒï¼Œéœ€è¦å•ç‹¬è§£æï¼Œè€Œä¸”ä¸€ä¸ªèŠå¤©è®°å½•çš„è§£æå¾€å¾€éœ€è¦è”åˆæŸ¥è¯¢å¤šä¸ªæ•°æ®åº“ï¼Œå› æ­¤ä»æ•°æ®åº“å¯¹è±¡è½¬æˆMessageå¯¹è±¡éœ€è¦å¤§é‡çš„if-elseæ“ä½œï¼Œä¸ºäº†é¿å…è¿™ç§éº»çƒ¦ï¼Œ**MemoTrace**ä½¿ç”¨ **å·¥å‚æ–¹æ³•æ¨¡å¼** åˆ›å»ºèŠå¤©æ¶ˆæ¯ï¼Œé’ˆå¯¹æ¯ä¸€ç§æ¶ˆæ¯ç±»å‹ä¸ºå…¶åˆ›å»ºå•ç‹¬çš„å·¥å‚æ–¹æ³•ï¼Œæ¯ç§æ¶ˆæ¯çš„åˆ›å»ºéƒ½æ˜¯ç‹¬ç«‹çš„ï¼Œå…·æœ‰æå¼ºçš„æ‰©å±•æ€§ã€‚å·¥å‚æ–¹æ³•æ¨¡å¼é€šè¿‡å®šä¹‰åˆ›å»ºå¯¹è±¡çš„æ¥å£æ¥å®ç°æ¶ˆæ¯å¯¹è±¡çš„çµæ´»æ„å»ºï¼ŒåŒæ—¶ç»“åˆå•ä¾‹æ¨¡å¼å…±äº«å·¥å‚å®ä¾‹ï¼Œæå‡äº†ç³»ç»Ÿçš„æ‰©å±•æ€§å’Œæ€§èƒ½ã€‚

![æ¶ˆæ¯åˆ›å»ºæµç¨‹](https://blog.lc044.love/static/img/c1442ee6aca0e334b90a4c242bbb511b.image.webp)

------

#### **5.2.1 è®¾è®¡ç›®æ ‡**

1. **è§£è€¦æ¶ˆæ¯ç±»å‹çš„åˆ›å»º**ï¼šé€šè¿‡å·¥å‚ç±»å®ç°åˆ›å»ºé€»è¾‘ï¼Œé¿å…åœ¨è°ƒç”¨ä»£ç ä¸­ç›´æ¥åˆå§‹åŒ–å…·ä½“æ¶ˆæ¯å¯¹è±¡ã€‚
2. **æ”¯æŒåŠ¨æ€æ‰©å±•æ¶ˆæ¯ç±»å‹**ï¼šé€šè¿‡æ³¨å†Œè¡¨æœºåˆ¶ï¼Œå¯ä»¥æ–¹ä¾¿åœ°æ–°å¢æ¶ˆæ¯ç±»å‹çš„å·¥å‚ã€‚
3. **æé«˜æ€§èƒ½**ï¼šå·¥å‚ç±»ä½¿ç”¨å•ä¾‹æ¨¡å¼ï¼Œç¡®ä¿åªå­˜åœ¨ä¸€ä¸ªå®ä¾‹ï¼Œå‡å°‘ä¸å¿…è¦çš„å®ä¾‹åŒ–æ“ä½œã€‚
4. **ç®€åŒ–ä¾èµ–ç®¡ç†**ï¼šé€šè¿‡ `Singleton` ç®¡ç†å…±äº«æ•°æ®ï¼ˆå¦‚è”ç³»äººä¿¡æ¯ï¼‰ã€‚

------

#### **5.2.2 æ ¸å¿ƒç»„ä»¶**

**5.2.2.1. æŠ½è±¡å·¥å‚ç±»ï¼š`MessageFactory`**

- `MessageFactory` æ˜¯æ‰€æœ‰å…·ä½“å·¥å‚ç±»çš„åŸºç±»ï¼Œå®šä¹‰äº†ç»Ÿä¸€çš„ `create` æ–¹æ³•ï¼Œç”¨äºåˆ›å»ºæ¶ˆæ¯å¯¹è±¡ã€‚

- æ–¹æ³•

  ï¼š

  - `create(data, username, database_manager)`ï¼šæŠ½è±¡æ–¹æ³•ï¼Œç”±å…·ä½“å·¥å‚ç±»å®ç°ï¼Œè´Ÿè´£æ ¹æ®è¾“å…¥æ•°æ®åˆ›å»ºæ¶ˆæ¯å¯¹è±¡ã€‚

------

**5.2.2.2. å•ä¾‹åŸºç±»ï¼š`Singleton`**

- ä¸ºå·¥å‚ç±»æä¾›å•ä¾‹åŠŸèƒ½ï¼Œç¡®ä¿æ¯ç§æ¶ˆæ¯ç±»å‹çš„å·¥å‚åªå­˜åœ¨ä¸€ä¸ªå®ä¾‹ã€‚
- **åŠŸèƒ½**ï¼š
  - **å…±äº«æ•°æ®ç®¡ç†**ï¼šé€šè¿‡ç±»æ–¹æ³• `set_shared_data` å’Œ `get_shared_data`ï¼Œç®¡ç†å·¥å‚ä¹‹é—´å…±äº«çš„æ•°æ®ã€‚
  - **è”ç³»äººç¼“å­˜**ï¼šé€šè¿‡ `contacts` å­—å…¸ç¼“å­˜è”ç³»äººä¿¡æ¯ï¼Œé¿å…é‡å¤æŸ¥è¯¢æ•°æ®åº“ã€‚
  - **èŠå¤©è®°å½•ç¼“å­˜**ï¼šé€šè¿‡ `messages` å­—å…¸ç¼“å­˜èŠå¤©è®°å½•ï¼Œæ–¹ä¾¿æŸ¥è¯¢å¼•ç”¨æ¶ˆæ¯ã€‚
  - **è”ç³»äººè·å–é€»è¾‘**ï¼š`get_contact(wxid, database_manager)` æ–¹æ³•ä»ç¼“å­˜æˆ–æ•°æ®åº“è·å–è”ç³»äººã€‚
- **ç¼“å­˜çš„è®¾è®¡**ï¼š
  - **ç¼“å­˜çš„å¤§å°**ï¼šç¡®ä¿ä¸è¶…è¿‡è®¾å®šçš„ k æ¡ç›®ã€‚è¶…å‡ºæ—¶ä¼šè‡ªåŠ¨åˆ é™¤æœ€æ—©æ’å…¥çš„æ¡ç›®ï¼Œè¿™æ ·å¯ä»¥ä¿æŒæœ€æ–°çš„æ•°æ®ï¼Œæœ‰æ•ˆèŠ‚çœå†…å­˜ã€‚
  - **å±€éƒ¨æ€§åŸç†**ï¼šé€‚åˆç”¨äºéœ€è¦å¿«é€Ÿè®¿é—®æœ€è¿‘ä½¿ç”¨æ•°æ®çš„åœºæ™¯ï¼Œè®¤ä¸ºåªä¼šå¼•ç”¨æœ€è¿‘å‡ºç°çš„èŠå¤©æ¶ˆæ¯ï¼Œå¦‚æœæ²¡æœ‰å°±å»æ•°æ®åº“é‡ŒæŸ¥æ‰¾ã€‚

------

**5.2.2.3. å·¥å‚å®ç°ç±»** æ¯ä¸ªå·¥å‚å®ç°ç±»ç»§æ‰¿è‡ª `MessageFactory` å’Œ `Singleton`ï¼Œç”¨äºåˆ›å»ºå…·ä½“çš„æ¶ˆæ¯å¯¹è±¡ã€‚

1. **`TextMessageFactory`**
   - ç”¨äºåˆ›å»ºæ–‡æœ¬æ¶ˆæ¯ï¼ˆ`TextMessage`ï¼‰ã€‚
   - å®ç° `create` æ–¹æ³•ï¼Œæ ¹æ®è¾“å…¥çš„æ•°æ®æ„é€ ä¸€ä¸ª `TextMessage` å®ä¾‹ã€‚
2. **`ImageMessageFactory`**
   - ç”¨äºåˆ›å»ºå›¾ç‰‡æ¶ˆæ¯ï¼ˆ`ImageMessage`ï¼‰ã€‚
   - å®ç° `create` æ–¹æ³•ï¼Œæ ¹æ®è¾“å…¥çš„æ•°æ®ï¼ˆåŒ…æ‹¬æ—¶é—´æˆ³ã€å‘é€è€… IDã€å›¾ç‰‡ URL å’Œåˆ†è¾¨ç‡ï¼‰æ„é€ ä¸€ä¸ª `ImageMessage` å®ä¾‹ã€‚

------

**5.2.2.4. å·¥å‚æ³¨å†Œè¡¨ï¼š`FACTORY_REGISTRY`**

- å®šä¹‰ä¸€ä¸ªæ³¨å†Œè¡¨ï¼Œç”¨äºåŠ¨æ€å…³è”æ¶ˆæ¯ç±»å‹ä¸å¯¹åº”çš„å·¥å‚å®ä¾‹ã€‚
- **åŠŸèƒ½**ï¼š
  - å­˜å‚¨æ¶ˆæ¯ç±»å‹ï¼ˆå¦‚ `text`, `image`ï¼‰åˆ°å…·ä½“å·¥å‚ç±»å®ä¾‹çš„æ˜ å°„ã€‚
  - å¯é€šè¿‡åŠ¨æ€æ‰©å±•æ³¨å†Œè¡¨æ”¯æŒæ–°çš„æ¶ˆæ¯ç±»å‹ã€‚

ç¤ºä¾‹æ³¨å†Œè¡¨å†…å®¹ï¼š

```yaml
python
# å·¥å‚æ³¨å†Œè¡¨
FACTORY_REGISTRY = {
    -1: UnknownMessageFactory(),
    MessageType.Text: TextMessageFactory(),
    MessageType.Image: ImageMessageFactory(),
    MessageType.Audio: AudioMessageFactory(),
    MessageType.Video: VideoMessageFactory(),
    Â·Â·Â·
    MessageType.Quote: QuoteMessageFactory(),
    MessageType.Transfer: TransferMessageFactory(),
    MessageType.RedEnvelope: RedEnvelopeMessageFactory(),
}
```

**YAML**

------

#### **5.2.3 ä¸»è¦ç±»åŠæ–¹æ³•çš„è¯¦ç»†æè¿°**

- **`MessageFactory`**

  - **å®šä¹‰**ï¼šæŠ½è±¡åŸºç±»ï¼Œæä¾›ç»Ÿä¸€æ¥å£ä»¥åˆ›å»ºæ¶ˆæ¯å¯¹è±¡ã€‚
  - **æ–¹æ³•**ï¼š
    - `create(data, username, database_manager)`ï¼š
      - **å‚æ•°**ï¼š
        - `data`ï¼šä»æ•°æ®åº“æŸ¥è¯¢æˆ–å¤–éƒ¨è·å–çš„æ¶ˆæ¯æ•°æ®ï¼ˆé€šå¸¸æ˜¯å…ƒç»„ï¼‰ã€‚
        - `username`ï¼šèŠå¤©å¯¹è±¡çš„å”¯ä¸€æ ‡è¯†ï¼ˆå¦‚ wxidï¼‰ã€‚
        - `database_manager`ï¼šç”¨äºæ•°æ®åº“æ“ä½œçš„æ¥å£ã€‚
      - **è¿”å›å€¼**ï¼šå…·ä½“çš„æ¶ˆæ¯å¯¹è±¡ã€‚

- **`Singleton`**

  - **å®šä¹‰**ï¼šæä¾›å•ä¾‹åŠŸèƒ½çš„åŸºç±»ã€‚
  - **åŠŸèƒ½**ï¼š
    - **å•ä¾‹ç®¡ç†**ï¼š
      - `__new__` æ–¹æ³•ç¡®ä¿æ¯ä¸ªå­ç±»åªæœ‰ä¸€ä¸ªå®ä¾‹ã€‚
    - **å…±äº«æ•°æ®ç®¡ç†**ï¼š
      - `set_shared_data`/`get_shared_data` ç”¨äºè®¾ç½®å’Œè·å–å…±äº«æ•°æ®ã€‚
    - **è”ç³»äººç¼“å­˜**ï¼š
      - `contacts`ï¼šå­˜å‚¨è”ç³»äººç¼“å­˜ä¿¡æ¯ã€‚
      - `set_contacts`ï¼šåˆå§‹åŒ–è”ç³»äººç¼“å­˜ã€‚
      - `get_contact(wxid, database_manager)`ï¼šä»ç¼“å­˜æˆ–æ•°æ®åº“è·å–è”ç³»äººã€‚

- **`TextMessageFactory`**

  - **åŠŸèƒ½**ï¼šè´Ÿè´£åˆ›å»º `TextMessage` å®ä¾‹ã€‚

  - å®ç°æ–¹æ³•

    ï¼š

    - ```
      create(data, username, database_manager)
      ```

      ï¼š

      - æ•°æ®å¤„ç†å’Œè½¬æ¢åï¼Œè¿”å› `TextMessage` å¯¹è±¡ã€‚

- **`ImageMessageFactory`**

  - **åŠŸèƒ½**ï¼šè´Ÿè´£åˆ›å»º `ImageMessage` å®ä¾‹ã€‚

  - å®ç°æ–¹æ³•

    ï¼š

    - ```
      create(data, username, database_manager)
      ```

      ï¼š

      - ä»è¾“å…¥æ•°æ®ä¸­æå– `timestamp`ã€`sender_id`ã€`image_url` å’Œ `resolution`ï¼Œå¹¶åˆ›å»ºä¸€ä¸ª `ImageMessage` å®ä¾‹ã€‚

- **å·¥å‚æ³¨å†Œè¡¨**

  - **å®šä¹‰**ï¼š`FACTORY_REGISTRY` æ˜¯ä¸€ä¸ªå­—å…¸ï¼Œå­˜å‚¨æ¶ˆæ¯ç±»å‹åˆ°å…·ä½“å·¥å‚å®ä¾‹çš„æ˜ å°„ã€‚
  - **ä½œç”¨**ï¼š
    - é€šè¿‡æ³¨å†Œè¡¨ï¼Œå¯ä»¥åŠ¨æ€æŸ¥æ‰¾åˆé€‚çš„å·¥å‚ç±»å®ä¾‹ä»¥åˆ›å»ºå¯¹åº”çš„æ¶ˆæ¯å¯¹è±¡ã€‚
    - ç¤ºä¾‹ï¼šæ ¹æ®æ¶ˆæ¯ç±»å‹ `text`ï¼Œä»æ³¨å†Œè¡¨è·å– `TextMessageFactory` çš„å®ä¾‹ï¼Œå¹¶è°ƒç”¨å…¶ `create` æ–¹æ³•ã€‚

------

#### **5.2.4 åˆ›å»ºæµç¨‹**

1. **å·¥å‚æ³¨å†Œ**ï¼š
   - å°†å„æ¶ˆæ¯ç±»å‹å¯¹åº”çš„å·¥å‚ç±»å®ä¾‹æ³¨å†Œåˆ° `FACTORY_REGISTRY` ä¸­ã€‚
   - å¦‚ `text` ç±»å‹å¯¹åº” `TextMessageFactory`ï¼Œ`image` ç±»å‹å¯¹åº” `ImageMessageFactory`ã€‚
2. **æ¶ˆæ¯åˆ›å»º**ï¼š
   - æ ¹æ®æ¶ˆæ¯ç±»å‹ä» `FACTORY_REGISTRY` è·å–å¯¹åº”çš„å·¥å‚å®ä¾‹ã€‚
   - è°ƒç”¨å·¥å‚å®ä¾‹çš„ `create` æ–¹æ³•ï¼Œç”Ÿæˆæ¶ˆæ¯å¯¹è±¡ã€‚

------

#### **5.2.5 å®Œæ•´è®¾è®¡å›¾**

![æ¶ˆæ¯åˆ›å»ºæµç¨‹](https://blog.lc044.love/static/img/c1442ee6aca0e334b90a4c242bbb511b.image.webp)

1. **æŠ½è±¡åŸºç±»**ï¼š`MessageFactory`
2. **å•ä¾‹ç®¡ç†**ï¼š`Singleton`
3. **å…·ä½“å·¥å‚ç±»**ï¼š
   - `TextMessageFactory`
   - `ImageMessageFactory`
4. **æ³¨å†Œè¡¨**ï¼š`FACTORY_REGISTRY`
5. **æ¶ˆæ¯å¯¹è±¡**ï¼š`TextMessage`, `ImageMessage` ç­‰

### **5.3 è”ç³»äººè®¾è®¡**

è®¾è®¡æ€è·¯

å¾®ä¿¡è”ç³»äººåˆ†ä¸ºæ™®é€šå¥½å‹ã€ç¾¤èŠã€ä¼ä¸šå¾®ä¿¡è”ç³»äººã€å…¬ä¼—å·å››ç§ç±»å‹

![è”ç³»äººç±»å›¾](https://blog.lc044.love/static/img/332355956d7588d36871bbb62172ad89.image.webp)

### **5.4 æ•°æ®åº“è®¾è®¡**

#### **5.4.1 æ¦‚è¿°**

å‰é¢æåˆ°ä¸€ä¸ªèŠå¤©æ¶ˆæ¯çš„æ„å»ºéœ€è¦è”åˆæŸ¥è¯¢å¤šä¸ªæ•°æ®åº“çš„ä¿¡æ¯ï¼Œå¾®ä¿¡v3å’Œå¾®ä¿¡v4çš„æ•°æ®åº“ç»“æ„ç›¸ä¼¼ä½†å·®å¼‚ä¹Ÿå¾ˆå¤§ã€‚åœ¨ **MemoTrace** 1.0çš„æ—¶å€™è·å–èŠå¤©è®°å½•ç›´æ¥æ“ä½œMSGå’Œå…¶ä»–ç›¸å…³æ•°æ®åº“ï¼ˆå¦‚ä¸‹å›¾æ‰€ç¤ºï¼‰ï¼Œä»»ä½•åº”ç”¨çš„ä¿®æ”¹å¯èƒ½ä¼šå½±å“å¤šä¸ªæ¨¡å—ï¼Œè€¦åˆåº¦è¾ƒé«˜ï¼Œä¸æ˜“æ‰©å±•å’Œç»´æŠ¤ï¼Œè·å–è”ç³»äººçš„æ—¶å€™ç”šè‡³å‡ºç°äº†[**å¾ªç¯ä¾èµ–**](https://github.com/LC044/WeChatMsg/blob/fc1e2fa7a54a0e80fc0e12f2adb56479de9e477c/app/DataBase/msg.py#L57)ï¼Œè¿åäº†å•ä¸€èŒè´£åŸåˆ™ï¼Œè¿™æ˜¯ç»å¯¹ä¸å…è®¸çš„ã€‚

![æ•°æ®åº“æ¨¡å—è°ƒç”¨å…³ç³»](https://blog.lc044.love/static/img/f3d15e897be6b7444bf44d87b0b50513.image.webp)

**MemoTrace** 2.0 ä¸ºäº†é™ä½æ¨¡å—ä¸åº”ç”¨ä¹‹é—´çš„è€¦åˆï¼Œå¢åŠ æ‰©å±•æ€§ï¼Œé‡‡ç”¨ä¸€ä¸ªä¸­é—´æ¨¡å—ç»Ÿä¸€ç®¡ç†å„ä¸ªå­ç³»ç»Ÿï¼Œè¿™å°±æ˜¯**å¤–è§‚æ¨¡å¼**ã€‚æ¯ä¸ªæ•°æ®åº“é‡‡ç”¨ä¸€ä¸ªæ¨¡å—å•ç‹¬ç®¡ç†ï¼Œå„æ•°æ®åº“ä¹‹é—´äº’ä¸ä¾èµ–ï¼Œ`Manager` æŸ¥è¯¢å¤šä¸ªå­æ•°æ®åº“ï¼Œé›†ä¸­å¤„ç†ä¸šåŠ¡é€»è¾‘ï¼Œå‡å°‘å„ä¸ªæ¨¡å—çš„é‡å¤ä»£ç ã€‚

![æ•°æ®åº“æ¨¡å—è°ƒç”¨å…³ç³»2](https://blog.lc044.love/static/img/0c68050801da8c925f5d7df44def25c1.image.webp)

ç”±äºå¾®ä¿¡æ•°æ®åº“æ˜¯å›ºå®šçš„ï¼Œ2.0 åŠ ä¸€ä¸ªä¸­é—´æ¨¡å—å¥½åƒå¹¶æ²¡æœ‰å¤ªå¤§ä½œç”¨ï¼Œæ‰€ä»¥åˆ°2.1ä»ç„¶æœ‰éƒ¨åˆ†åŠŸèƒ½æ²¡æœ‰æ•´åˆåˆ° `Maanager` ä¸­ï¼ˆä¸»è¦æ˜¯å› ä¸º1.0çš„ä»£ç èƒ½ç”¨å°±æ‡’å¾—æ”¹äº†ï¼‰ï¼Œç›´åˆ°å¾®ä¿¡4.0çš„å‡ºç°æ‰æ„è¯†åˆ°è¿™ç§è®¾è®¡çš„å¥½å¤„ã€‚åªéœ€è¦å†å¢åŠ ä¸€ä¸ªä¸ `Manager1` ç›¸åŒæ¥å£çš„ `Manager2` å³å¯ä¸æ›´æ”¹ä¸Šå±‚åº”ç”¨ç¨‹åºè€Œå¢åŠ å¾®ä¿¡4.0çš„æ”¯æŒã€‚

![æ•°æ®åº“æ¨¡å—è°ƒç”¨å…³ç³»3](https://blog.lc044.love/static/img/f7b818031bfa6999b44bf10a06bdfd50.image.webp)

ç»å†ä¸‰ä¸ªé˜¶æ®µæ‰å½¢æˆäº†ä¸‹é¢çš„æ•°æ®åº“æ¨¡å—æ¶æ„ï¼š

![æ•°æ®åº“æ¨¡å—æ¶æ„](https://blog.lc044.love/static/img/0fbb4eafa332f2a77d912ffa9c72f0bd.image.webp)

#### **5.4.2 æ ¸å¿ƒç±»**

## å…­ã€ğŸ“œé™„å½•1 å¾®ä¿¡v4æ•°æ®åº“

### 6.1 è”ç³»äººcontact

> è¿™éƒ¨åˆ†å­˜å‚¨äº†å¾®ä¿¡é‡Œçš„è”ç³»äººä¿¡æ¯ï¼ŒåŒ…æ‹¬å¥½å‹ã€ç¾¤èŠã€ä¼ä¸šå¾®ä¿¡è”ç³»äººã€å…¬ä¼—å·ç­‰ä¿¡æ¯

#### **biz_info å…¬ä¼—å·æ•°æ®**

```vbnet
sql
CREATE TABLE biz_info(
    id INTEGER PRIMARY KEY, 
    username TEXT, 
    type INTEGER, 
    accept_type INTEGER, 
    child_type INTEGER, 
    version INTEGER, 
    external_info TEXT, 
    brand_info TEXT, 
    brand_icon_url TEXT, 
    brand_list TEXT, 
    brand_flag INTEGER, 
    belong TEXT, 
    ext_buffer BLOB
)
```

**VB.Net**

| åç§°           | ç±»å‹    | è¯´æ˜                                            |
| -------------- | ------- | ----------------------------------------------- |
| id             | INTEGER | è·Ÿname2idè¡¨çš„åºå·ç›¸å¯¹åº”ï¼Œå¯ä»¥å”¯ä¸€ç¡®å®šä¸€ä¸ªè”ç³»äºº |
| username       | TEXT    | åŸå§‹wxidï¼Œå¯ä»¥å”¯ä¸€ç¡®å®šä¸€ä¸ªè”ç³»äºº                |
| type           | INTEGER | å…¬ä¼—å·ç±»å‹ï¼Œ1æ˜¯å…¬ä¼—å·ï¼Œ0æ˜¯è®¢é˜…å·                |
| accept_type    | INTEGER |                                                 |
| child_type     | INTEGER |                                                 |
| version        | INTEGER |                                                 |
| external_info  | TEXT    | å­˜å‚¨äº†å…¬ä¼—å·çš„è¯¦ç»†ä¿¡æ¯ï¼Œå…¬ä¼—å·åº•éƒ¨èœå•ä¿¡æ¯      |
| brand_info     | TEXT    |                                                 |
| brand_icon_url | TEXT    | logoé“¾æ¥                                        |
| brand_list     | TEXT    |                                                 |
| brand_flag     | INTEGER |                                                 |
| belong         | TEXT    |                                                 |
| ext_buffer     | BLOB    |                                                 |

------

#### **biz_session_feed å…¬ä¼—å·æ¶ˆæ¯ä¼šè¯**

```sql
sql
CREATE TABLE biz_session_feeds(
    username TEXT, 
    showname TEXT, 
    desc TEXT, type INTEGER, 
    unread_count INTEGER, 
    update_time INTEGER, 
    create_time INTEGER, 
    biz_attr_version INTEGER
)
```

**SQL**

| åç§°             | ç±»å‹    | è¯´æ˜             |
| ---------------- | ------- | ---------------- |
| username         | TEXT    |                  |
| showname         | TEXT    | å±å¹•ä¸Šæ˜¾ç¤ºçš„åå­— |
| desc             | TEXT    | æ¶ˆæ¯æè¿°ä¿¡æ¯     |
| type             | INTEGER | æ¶ˆæ¯ç±»å‹         |
| unread_count     | INTEGER | æœªè¯»æ¶ˆæ¯çš„ä¸ªæ•°   |
| update_time      | INTEGER | æ›´æ–°æ—¶é—´         |
| create_time      | INTEGER | åˆ›å»ºæ—¶é—´         |
| biz_attr_version | INTEGER |                  |

------

#### **chat_room ç¾¤èŠ**

```sql
sql
CREATE TABLE chat_room(
  id INTEGER PRIMARY KEY, 
  username TEXT, 
  owner TEXT, 
  ext_buffer BLOB
)
```

**SQL**

| åç§°       | ç±»å‹           | è¯´æ˜                           |
| ---------- | -------------- | ------------------------------ |
| id         | INTEGER        | è·Ÿname2idè¡¨çš„åºå·ç›¸å¯¹åº”        |
| username   | TEXT           | ç¾¤èŠçš„username                 |
| owner      | TEXT           | ç¾¤ä¸»çš„username                 |
| ext_buffer | BLOB(protobuf) | å­˜å‚¨äº†ç¾¤æˆå‘˜çš„usernameå’Œç¾¤æ˜µç§° |

```java
python
syntax = "proto3";
package app.protobuf;
option go_package=".;proto";

message ChatRoomData {
  message ChatRoomMember {
      string wxID = 1;
      string displayName = 2;
      int32 state = 3;
  }
  repeated ChatRoomMember members = 1;
  int32 field_2 = 2;
  int32 field_3 = 3;
  int32 field_4 = 4;
  int32 room_capacity = 5;
  int32 field_6 = 6;
  int64 field_7 = 7;
  int64 field_8 = 8;
}
```

**Java**

------

#### **chat_room_info_detail ç¾¤èŠä¿¡æ¯**

```vbnet
sql
CREATE TABLE chat_room_info_detail(
    room_id_ INTEGER PRIMARY KEY, 
    username_ TEXT, 
    announcement_ TEXT, 
    announcement_editor_ TEXT, 
    announcement_publish_time_ INTEGER, 
    chat_room_status_ INTEGER, 
    room_top_msg_closed_id_list_text_ TEXT, 
    xml_announcement_ TEXT, 
    ext_buffer_ BLOB
)
```

**VB.Net**

| åç§°                              | ç±»å‹    | è¯´æ˜                                                         |
| --------------------------------- | ------- | ------------------------------------------------------------ |
| room_id_                          | INTEGER | è·Ÿname2idè¡¨çš„åºå·ç›¸å¯¹åº”                                      |
| username_                         | TEXT    | ç¾¤èŠçš„username                                               |
| announcement_                     | TEXT    | å­˜æ–‡æœ¬å½¢å¼çš„ç¾¤å…¬å‘Š                                           |
| announcement_editor_              | TEXT    | ç¾¤åŠŸèƒ½ç¼–è¾‘è€…çš„username                                       |
| announcement_publish_time_        | INTEGER | å‘å¸ƒæ—¶é—´                                                     |
| chat_room_status_                 | INTEGER |                                                              |
| room_top_msg_closed_id_list_text_ | TEXT    |                                                              |
| xml_announcement_                 | TEXT    | xmlæ ¼å¼çš„ç¾¤åŠŸèƒ½ï¼Œå¯ä»¥è§£æå‡ºæ¥æ›´å¤šä¿¡æ¯ï¼Œå¦‚å›¾ç‰‡ã€æ–‡ä»¶ä¹‹ç±»çš„ä¿¡æ¯ |
| ext_buffer_                       |         |                                                              |

------

#### **chatroom_member ç¾¤æˆå‘˜è¡¨**

```sql
sql
CREATE TABLE chatroom_member(
    room_id INTEGER, 
    member_id INTEGER, 
    CONSTRAINT room_member UNIQUE(room_id, member_id)
)
```

**SQL**

| åç§°      | ç±»å‹    | è¯´æ˜                            |
| --------- | ------- | ------------------------------- |
| room_id   | INTEGER | ç¾¤èŠidï¼Œè·Ÿname2idè¡¨çš„åºå·ç›¸å¯¹åº” |
| member_id | INTEGER | ç¾¤å‘˜idï¼Œè·Ÿname2idè¡¨çš„åºå·ç›¸å¯¹åº” |

------

#### **contact è”ç³»äººè¡¨**

> contactå­˜å‚¨äº†æ‰€æœ‰çš„è”ç³»äººï¼ŒåŒ…æ‹¬å¥½å‹ã€ç¾¤èŠã€å…¬ä¼—å·ã€ä¼ä¸šå¾®ä¿¡è”ç³»äºº

```vbnet
sql
CREATE TABLE contact(
    id INTEGER PRIMARY KEY, 
    username TEXT, 
    local_type INTEGER, 
    alias TEXT, 
    encrypt_username TEXT, 
    flag INTEGER, 
    delete_flag INTEGER, 
    verify_flag INTEGER, 
    remark TEXT, 
    remark_quan_pin TEXT, 
    remark_pin_yin_initial TEXT, 
    nick_name TEXT, 
    pin_yin_initial TEXT, 
    quan_pin TEXT, 
    big_head_url TEXT, 
    small_head_url TEXT, 
    head_img_md5 TEXT, 
    chat_room_notify INTEGER, 
    is_in_chat_room INTEGER, 
    description TEXT, 
    extra_buffer BLOB, 
    chat_room_type INTEGER
)
```

**VB.Net**

| åç§°                   | ç±»å‹           | è¯´æ˜                                           |
| ---------------------- | -------------- | ---------------------------------------------- |
| id                     | INTEGER        | åºå·ï¼Œè·Ÿname2idè¡¨çš„åºå·ç›¸å¯¹åº”                  |
| user naI He            | TEXT           | è”ç³»äººçš„wixd                                   |
| local_type             | INTEGER        | ç±»å‹                                           |
| alias                  | TEXT           | å¾®ä¿¡é‡Œæ˜¾ç¤ºçš„å¾®ä¿¡å·                             |
| encrypt_username       | TEXT           |                                                |
| flag                   | INTEGER        | å¥½åƒæ˜¯è”ç³»äººçš„çœŸæ­£ç±»å‹ï¼Œè·Ÿ3.0æ•°æ®åº“çš„Typeå¯¹åº”  |
| delete_flag            | INTEGER        |                                                |
| verify_flag            | INTEGER        |                                                |
| remark                 | TEXT           | å¤‡æ³¨å                                         |
| remark_quan_pin        | TEXT           | å¤‡æ³¨åå…¨æ‹¼                                     |
| remark_pin_yin_initial | TEXT           | å¤‡æ³¨åæ‹¼éŸ³ç¼©å†™                                 |
| nick_name              | TEXT           | å¾®ä¿¡æ˜µç§°                                       |
| pin_yin_initial        | TEXT           | å¾®ä¿¡æ˜µç§°æ‹¼éŸ³ç¼©å†™                               |
| quan_pin               | TEXT           | å¾®ä¿¡æ˜µç§°å…¨æ‹¼                                   |
| big_head_url           | TEXT           | å¥½å‹å¤´åƒå¤§å›¾                                   |
| small_head_url         | TEXT           | å¥½å‹å¤´åƒå°å›¾                                   |
| head_img_md5           | TEXT           | å¤´åƒçš„md5ï¼Œå¯ä»¥é€šè¿‡head_image.dbæŸ¥è¯¢å¯¹åº”çš„å¤´åƒ |
| chat_room_notify       | INTEGER        | "chat_room_notify" INTEGER                     |
| is_in_chat_room        | INTEGER        | "is_in_chat_room" INTEGER                      |
| description            | TEXT           | "description" TEXT                             |
| extra_buffer           | BLOB(protobuf) | å­˜å‚¨äº†å¥½å‹çš„è¯¦ç»†ä¿¡æ¯ï¼Œæ€§åˆ«ã€åœ°åŒºã€ç­¾åç­‰       |
| chat_room_type         | INTEGER        | "chat_room_type" INTEGER                       |

ç›¸å…³ä¿¡æ¯

local_typeè¯´æ˜ï¼š

1ï¼šé€šè®¯å½•å¥½å‹ï¼ˆåŒ…æ‹¬å…¬ä¼—å·ã€æ‰‹åŠ¨æ·»åŠ åˆ°é€šè®¯å½•çš„ç¾¤èŠï¼‰

2ï¼šæœªæ·»åŠ åˆ°é€šè®¯å½•çš„ç¾¤èŠ

3ï¼šç¾¤ä¸­çš„é™Œç”Ÿäºº

5ï¼šä¼ä¸šå¾®ä¿¡å¥½å‹

6ï¼šç¾¤èŠä¸­çš„é™Œç”Ÿä¼ä¸šå¾®ä¿¡å¥½å‹

ç›¸å…³ä¿¡æ¯

flagè¯´æ˜ï¼š

flagè¦è½¬åŒ–ä¸ºäºŒè¿›åˆ¶ï¼Œæ¯ä¸€ä½ä»£è¡¨ä¸åŒçš„å«ä¹‰

ç¬¬7ä½ï¼šä»£è¡¨æ˜¯å¦æ˜¯æ˜Ÿæ ‡å¥½å‹

ç¬¬12ä½ï¼š ä»£è¡¨æ˜¯å¦æ˜¯ç½®é¡¶å¥½å‹

ç¬¬17ä½ï¼šä»£è¡¨æ˜¯å¦å±è”½å¯¹æ–¹çš„æœ‹å‹åœˆ

ç¬¬24ä½ï¼šä»£è¡¨æ˜¯å¦æ˜¯ä»…èŠå¤©å¥½å‹

**`extra_buffer` å¯¹åº”çš„ `.proto` æ–‡ä»¶æè¿°**

```java
text
syntax = "proto3";

package example;

// é¡¶çº§æ¶ˆæ¯å®šä¹‰
message ContactInfo {
  // varint ç±»å‹å­—æ®µï¼Œæ ¹æ®æ•°å€¼èŒƒå›´é€‰ç”¨ uint32 æˆ– uint64
  uint32 gender  = 2;  // æ€§åˆ«:1 ç”· 2:å¥³ 0:æœªçŸ¥
  uint32 field3  = 3;
  string signature  = 4;  // è‡ªåŠ©è€…å¤©åŠ©ï¼ï¼ï¼
  string country  = 5;  // CN
  string province  = 6;  // Shaanxi
  string city  = 7;  // Xi'an
  uint32 field8  = 8;
  string field9  = 9;
  uint32 field10 = 10; // 4294967295
  uint32 field11 = 11;
  uint32 field12 = 12;

  // ä¿®æ”¹åçš„åµŒå¥—æ¶ˆæ¯ï¼Œå¯¹åº” JSON ä¸­ field 14 çš„æ•°æ®ç»“æ„
  MessageField14 phone_info = 14;

  string field15 = 15;
  uint32 field16 = 16;
  uint32 field17 = 17;
  uint32 field18 = 18;
  uint32 field19 = 19;
  string field20 = 20;
  string field21 = 21;
  uint32 field22 = 22;
  uint32 field23 = 23;
  uint32 field24 = 24;
  string field25 = 25;
  string field26 = 26;

  // åµŒå¥—æ¶ˆæ¯ï¼Œæœ‹å‹åœˆèƒŒæ™¯
  MessageField27 moments_info = 27;

  string field28 = 28;
  string field29 = 29;
  string label_list = 30;
  string field31 = 31;
  string field32 = 32;

  // åµŒå¥—æ¶ˆæ¯ï¼Œå¯¹åº” JSON ä¸­ field 33 çš„ length_delimited æ•°æ®
  MessageField33 field33 = 33;

  string field34 = 34;
  string field35 = 35;
  MessageField36 field36 = 36;
  uint32 field37 = 37;
  uint32 field38 = 38; // 4294967295
}

// å®šä¹‰ field14 å¯¹åº”çš„åµŒå¥—æ¶ˆæ¯
// ä¿®æ”¹åçš„åµŒå¥—æ¶ˆæ¯ï¼Œç”¨äº field 14
message MessageField14 {
  uint32 field1 = 1; // varint ç±»å‹å­—æ®µï¼Œå­˜å‚¨æ•°å­—
  repeated MessageField14_Result2 field2 = 2; // è¿™æ˜¯ä¸€ä¸ª length_delimited ç±»å‹çš„å­—æ®µï¼ŒåŒ…å«å¤šä¸ªç»“æœ
}


message MessageField14_Result2 {
  string phone_numer = 1;  // string ç±»å‹å­—æ®µï¼Œå­˜å‚¨ç”µè¯å·ç 
}

// å®šä¹‰ field27 å¯¹åº”çš„åµŒå¥—æ¶ˆæ¯

message MessageField27 {
  uint32 field1 = 1;
  string background_url = 2; // å›¾ç‰‡ URL
  uint64 field3 = 3; // 14588734692813845087ï¼ˆå¤§æ•°ï¼Œç”¨ uint64ï¼‰
  uint32 field4 = 4; // 6785
  uint32 field5 = 5; // 4320
}

// å®šä¹‰ field33 å¯¹åº”çš„åµŒå¥—æ¶ˆæ¯

message MessageField33 {
  string field1 = 1;
}

message MessageField36 {
  MessageField36_Result results = 1;
}

message MessageField36_Result {
  string field1 = 1;
} 
```

**Java**

------

### 6.2 å¤´åƒ head_image

**head_image è¡¨**

```sql
sql
CREATE TABLE head_image(
    username TEXT PRIMARY KEY, 
    md5 TEXT, 
    image_buffer BLOB, 
    update_time INTEGER
)
```

**SQL**

| åç§°         | ç±»å‹    | è¯´æ˜                   |
| ------------ | ------- | ---------------------- |
| username     | INTEGER | wxid                   |
| md5          | TEXT    | å¤´åƒçš„md5              |
| image_buffer | BLOB    | å¤´åƒç¼©ç•¥å›¾çš„äºŒè¿›åˆ¶æ•°æ® |
| update_time  | INTEGER | æ›´æ–°æ—¶é—´               |

------

### 6.3 èŠå¤©è®°å½• message

#### message_x.db èŠå¤©æ•°æ®

Msg_md5è¡¨ï¼Œæ¯ä¸ªè”ç³»äººéƒ½å•ç‹¬å»ºäº†ä¸€ä¸ªè¡¨ï¼Œå‘½åè§„åˆ™ï¼šMsg_{md5(wxid)} , å¯¹è”ç³»äººçš„wxidç”¨md5ç¼–ç å¯ä»¥å¾—åˆ°èŠå¤©è®°å½•æ‰€åœ¨çš„è¡¨

```sql
sql
CREATE TABLE Msg_xxxx(
    local_id INTEGER PRIMARY KEY AUTOINCREMENT, 
    server_id INTEGER, 
    local_type INTEGER, 
    sort_seq INTEGER, 
    real_sender_id INTEGER, 
    create_time INTEGER, 
    status INTEGER, 
    upload_status INTEGER, 
    download_status INTEGER, 
    server_seq INTEGER, 
    origin_source INTEGER, 
    source TEXT, 
    message_content TEXT, 
    compress_content TEXT, 
    packed_info_data BLOB, 
    WCDB_CT_message_content INTEGER DEFAULT NULL, 
    WCDB_CT_source INTEGER DEFAULT NULL
)
```

**SQL**

| åç§°                     | ç±»å‹    | è¯´æ˜                                                         |
| ------------------------ | ------- | ------------------------------------------------------------ |
| local_id                 | INTEGER | è‡ªå¢id                                                       |
| server_id                | INTEGER | æœåŠ¡ç«¯çš„idï¼Œæ¯æ¡æ¶ˆæ¯çš„å”¯ä¸€id                                 |
| local_type               | INTEGER | æ¶ˆæ¯ç±»å‹                                                     |
| sort_seq                 | INTEGER | ç”¨äºæ’åºçš„å­—æ®µï¼Œæ—¶é—´æˆ³*100ï¼Œç„¶åä»0è®¡æ•°ï¼Œå¦‚æœæŸä¸€ç§’å‘é€äº†å¤šæ¡æ¶ˆæ¯ï¼Œå¯ä»¥é€šè¿‡è¯¥å­—æ®µåŒºåˆ†å…ˆåé¡ºåº |
| real_sender_id           | INTEGER | å‘é€è€…idï¼Œå¯ä»¥é€šè¿‡Name2Idè¡¨è·å–å®é™…çš„å‘é€è€…username          |
| create_time              | INTEGER | ç§’çº§æ—¶é—´æˆ³                                                   |
| status                   | INTEGER | æ¶ˆæ¯çŠ¶æ€                                                     |
| upload_status            | INTEGER | ä¸Šä¼ çŠ¶æ€                                                     |
| download_status          | INTEGER | ä¸‹è½½çŠ¶æ€                                                     |
| server_SEQ               | INTEGER | æœåŠ¡ç«¯æ¥æ”¶çš„é¡ºåºid                                           |
| origin_source            | INTEGER |                                                              |
| message_content          | TEXT    | æ¶ˆæ¯çš„å®é™…å†…å®¹ï¼Œlocal_typeæ˜¯1æ—¶message_contentæ˜¯æ–‡æœ¬æ•°æ®ï¼Œå…¶ä»–ç±»å‹éƒ½æ˜¯ `Zstandard` å‹ç¼©åçš„xmläºŒè¿›åˆ¶æ•°æ® |
| compress_content         | TEXT    | å‹ç¼©åçš„å†…å®¹                                                 |
| packed_info_data         | BLOB    | protobufæ•°æ®ï¼Œå­˜å‚¨äº†æŸäº›ç±»å‹çš„èŠå¤©è®°å½•çš„ä¿¡æ¯ï¼ˆå›¾ç‰‡æ–‡ä»¶åã€è¯­éŸ³è½¬æ–‡å­—è®°å½•ã€åˆå¹¶è½¬å‘çš„èŠå¤©è®°å½•æ–‡ä»¶åï¼‰ |
| WCD B_CT_message_content | INTEGER |                                                              |
| WCD B_CT_source          | INTEGER |                                                              |

**local_typeå­—æ®µè¯´æ˜**

| local_type    | ç±»å‹               | è¯´æ˜                     |
| ------------- | ------------------ | ------------------------ |
| 1             | æ–‡æœ¬               |                          |
| 3             | å›¾ç‰‡               |                          |
| 34            | è¯­éŸ³               |                          |
| 42            | å¥½å‹åç‰‡           | åŒ…å«å¥½å‹åç‰‡å’Œå…¬ä¼—å·åç‰‡ |
| 43            | è§†é¢‘               |                          |
| 47            | è¡¨æƒ…åŒ…             |                          |
| 48            | å‘é€çš„ä½ç½®ä¿¡æ¯     |                          |
| 50            | éŸ³è§†é¢‘é€šè¯         |                          |
| 66            | ä¼ä¸šå¾®ä¿¡å¥½å‹åç‰‡   |                          |
| 10000         | ç³»ç»Ÿæ¶ˆæ¯           | æ’¤é”€ä¿¡æ¯ï¼Œè¿›ç¾¤é€šçŸ¥ç­‰     |
| 25769803825   | æ–‡ä»¶               |                          |
| 21474836529   | åˆ†äº«é“¾æ¥           |                          |
| 292057776177  | åˆ†äº«é“¾æ¥           |                          |
| 4294967345    | åˆ†äº«é“¾æ¥           |                          |
| 326417514545  | åˆ†äº«é“¾æ¥           |                          |
| 17179869233   | åˆ†äº«é“¾æ¥           |                          |
| 244813135921  | å¼•ç”¨æ¶ˆæ¯           |                          |
| 81604378673   | åˆå¹¶è½¬å‘çš„èŠå¤©è®°å½• |                          |
| 8594229559345 | çº¢åŒ…               |                          |
| 219043332145  | è§†é¢‘å·             |                          |
| 141733920817  | å°ç¨‹åº             |                          |
| 154618822705  | å°ç¨‹åº             |                          |
| 103079215153  | è½¬å‘çš„æ”¶è—ç¬”è®°     |                          |
| 266287972401  | æ‹ä¸€æ‹             |                          |
| 12884901937   | éŸ³ä¹åˆ†äº«           |                          |

**packed_info_data** å­—æ®µå­˜å‚¨äº†æŸäº›èŠå¤©è®°å½•çš„é™„åŠ ä¿¡æ¯ï¼Œä¾‹å¦‚è¯­éŸ³è½¬æ–‡å­—ï¼Œå›¾ç‰‡åï¼ˆ2025å¹´3æœˆå¾®ä¿¡æµ‹è¯•ç‰ˆä¿®æ”¹äº†imgå‘½åæ–¹å¼æ‰æœ‰äº†è¿™ä¸ªä¸œè¥¿ï¼‰ï¼Œåˆå¹¶è½¬å‘çš„èŠå¤©è®°å½•æ–‡ä»¶å¤¹å

- å›¾ç‰‡

  ```java
  text
  syntax = "proto3";
  // 2025å¹´3æœˆå¾®ä¿¡æµ‹è¯•ç‰ˆä¿®æ”¹äº†imgå‘½åæ–¹å¼æ‰æœ‰äº†è¿™ä¸ªä¸œè¥¿
  message PackedInfoDataImg {
    int32 field1 = 1;
    int32 field2 = 2;
    string filename = 3;
  }
  ```

  **Java**

- è¯­éŸ³

  ```java
  text
  syntax = "proto3";
  
  package example;
  
  // é¡¶çº§æ¶ˆæ¯å®šä¹‰
  message PackedInfoData {
    // varint ç±»å‹å­—æ®µï¼Œæ ¹æ®æ•°å€¼èŒƒå›´é€‰ç”¨ uint32 æˆ– uint64
    uint32 field1  = 1;
    uint32 field2  = 2;
    MessageField5 info = 5;
  }
  
  // å®šä¹‰ field14 å¯¹åº”çš„åµŒå¥—æ¶ˆæ¯
  // ä¿®æ”¹åçš„åµŒå¥—æ¶ˆæ¯ï¼Œç”¨äº field 14
  message MessageField5 {
    uint32 field1 = 1;
    string audioTxt = 2; // è¯­éŸ³è½¬æ–‡å­—ç»“æœ
  }
  ```

  **Java**

- åˆå¹¶è½¬å‘çš„èŠå¤©è®°å½•

  ```java
  text
    syntax = "proto3";
  
    message PackedInfoData {
      int32 field1 = 1;
      int32 field2 = 2;
      NestedMessage field7 = 7;
      AnotherNestedMessage info = 9;
    }
  
    message NestedMessage {
      SubMessage1 field1 = 1;
      SubMessage2 field2 = 2;
      string field3 = 3;
    }
  
    message SubMessage1 {
      int32 field1 = 1;
      string field2 = 2;
    }
  
    message SubMessage2 {
      string field1 = 1;
      string field2 = 2;
      string field3 = 3;
    }
  
    message AnotherNestedMessage {
      string dir = 1;
    }
  ```

  **Java**

#### biz_message_x.db å…¬ä¼—å·æ¶ˆæ¯

å…¬ä¼—å·æ¶ˆæ¯è®°å½•ï¼Œç»“æ„åŒmessage_x.db

#### media_0.db è¯­éŸ³æ•°æ®

```sql
sql
CREATE TABLE VoiceInfo(
  chat_name_id INTEGER, 
  create_time INTEGER, 
  local_id INTEGER, 
  svr_id INTEGER, 
  voice_data BLOB, 
  data_index TEXT DEFAULT '0'
)
```

**SQL**

| åç§°         | ç±»å‹    | è¯´æ˜                              |
| ------------ | ------- | --------------------------------- |
| chat_name_id | INTEGER | ç»“åˆName2Idè¡¨å¯ä»¥æŸ¥å‡ºå‘é€è€…çš„wxid |
| create_time  | INTEGER | åˆ›å»ºç§’çº§æ—¶é—´æˆ³                    |
| local_id     | INTEGER | å¯¹åº”messageæ•°æ®åº“çš„local_id       |
| svr_id       | INTEGER | å¯¹åº”messageæ•°æ®åº“çš„server_id      |
| voice_data   | BLOB    | è¯­éŸ³silkçš„äºŒè¿›åˆ¶æ•°æ®              |
| data_index   | TEXT    |                                   |

------

### 6.4 æ–‡ä»¶ã€è§†é¢‘ã€å›¾ç‰‡ hardlink.db

**video_hardlink_info_v3**

```sql
sql
CREATE TABLE video_hardlink_info_v3(
    md5_hash INTEGER, 
    md5 TEXT, type INTEGER, 
    file_name TEXT, 
    file_size INTEGER, 
    modify_time INTEGER, 
    dir1 INTEGER, 
    dir2 INTEGER, 
    _rowid_ INTEGER PRIMARY KEY ASC, 
    extra_buffer BLOB
)
```

**SQL**

| åç§°         | ç±»å‹    | è¯´æ˜                                                         |
| ------------ | ------- | ------------------------------------------------------------ |
| md5hash      | INTEGER |                                                              |
| md5          | TEXT    | æ–‡ä»¶çš„md5                                                    |
| type         | INTEGER | æ–‡ä»¶ç±»å‹ï¼š3ï¼šæ­£å¸¸çš„æ–‡ä»¶ï¼Œ5ï¼šåˆå¹¶è½¬å‘çš„èŠå¤©è®°å½•é‡Œçš„æ–‡ä»¶       |
| file_name    | INTEGER | æ–‡ä»¶å                                                       |
| file_size    | INTEGER | æ–‡ä»¶å¤§å°(B)                                                  |
| modeify_time | INTEGER | ä¿®æ”¹æ—¶é—´                                                     |
| dir1         | INTEGER | æ–‡ä»¶å¤¹1çš„idï¼Œdir2idè¡¨å¯¹åº”ç¬¬idè¡Œusernamezå­—æ®µä¸ºdir1çš„æ–‡ä»¶å¤¹å |
| dir2         | INTEGER | æ–‡ä»¶å¤¹2çš„idï¼Œtypeä¸º3æ—¶dir2å€¼ä¸º0ï¼Œåªéœ€è¦ä»msg/video/dir1æ–‡ä»¶å¤¹ä¸­æ‰¾å°±è¡Œäº† |
| _*rowid*     | INTEGER |                                                              |
| extra_buffer | BLOB    | protocbufæ•°æ®ï¼Œå­˜å‚¨å¦ä¸€ä¸ªæ–‡ä»¶å¤¹dir3ï¼Œtypeä¸º5æ—¶æœ‰æ•ˆã€‚.proto æ–‡ä»¶æè¿°ï¼š`syntax = "proto3"; package example; message FileInfoData { string dir3 = 1; uint32 file_size = 2; }` |

```csharp
sql
select file_size,type,file_name,dir2id.username,_rowid_,modify_time
from video_hardlink_info_v3
join  dir2id on dir2id.rowid = dir1
where md5=10086;
```

**C#**

åˆå¹¶è½¬å‘çš„èŠå¤©è®°å½•

- æ–‡ä»¶è·¯å¾„ï¼š
  - msg\attach\9e20f478899dc29eb19741386f9343c8\2025-03\Rec\409af365664e0c0d\F\5\xxx.pdf
- å›¾ç‰‡è·¯å¾„ï¼š
  - msg\attach\9e20f478899dc29eb19741386f9343c8\2025-03\Rec\409af365664e0c0d\Img\5
- è§†é¢‘è·¯å¾„ï¼š
  - msg\attach\9e20f478899dc29eb19741386f9343c8\2025-03\Rec\409af365664e0c0d\V\5.mp4

```
9e20f478899dc29eb19741386f9343c8` æ˜¯wxidçš„md5åŠ å¯†ï¼Œ`409af365664e0c0d` æ˜¯ä¸Šè¿° `extra_buffer` å­—æ®µé‡Œçš„ `dir3
```

æ–‡ä»¶å¤¹æœ€åçš„5ä»£è¡¨çš„è¯¥æ–‡ä»¶æ˜¯åˆå¹¶è½¬å‘çš„èŠå¤©è®°å½•ç¬¬5æ¡æ¶ˆæ¯ï¼Œå¦‚æœå­˜åœ¨åµŒå¥—çš„åˆå¹¶è½¬å‘çš„èŠå¤©è®°å½•ï¼Œåˆ™ä¾æ¬¡é€’å½’çš„æ·»åŠ ä¸Šä¸€å±‚çš„æ–‡ä»¶ååç¼€ï¼Œä¾‹å¦‚ï¼šåˆå¹¶è½¬å‘çš„èŠå¤©è®°å½•æœ‰ä¸¤å±‚

```markdown
plain
0ï¼šæ–‡ä»¶ï¼ˆæ–‡ä»¶å¤¹åä¸º0ï¼‰

1ï¼šå›¾ç‰‡ ï¼ˆæ–‡ä»¶åä¸º1ï¼‰

2ï¼šåˆå¹¶è½¬å‘çš„èŠå¤©è®°å½•

    0ï¼šæ–‡ä»¶ï¼ˆæ–‡ä»¶å¤¹åä¸º2_0ï¼‰

    1ï¼šå›¾ç‰‡ï¼ˆæ–‡ä»¶åä¸º2_1ï¼‰

    2ï¼šè§†é¢‘ï¼ˆæ–‡ä»¶åä¸º2_2.mp4ï¼‰
```

**Markdown**

```python
python
def parser_merged(merged_messages, level):
    for index, inner_msg in enumerate(merged_messages):
        wxid_md5 = hashlib.md5(username.encode("utf-8")).hexdigest()
        if inner_msg.type == MessageType.Image:
           inner_msg.path = os.path.join(
               'msg', 'attach', wxid_md5, month,
                'Rec', dir0, 'Img', f"{level}{'_' if level else ''}{index}")
           inner_msg.thumb_path = os.path.join(
               'msg', 'attach', wxid_md5, month,
                'Rec', dir0, 'Img', f"{level}{'_' if level else ''}{index}_t")
       elif inner_msg.type == MessageType.Video:
            inner_msg.path = os.path.join(
                'msg', 'attach',wxid_md5,month,
                'Rec', dir0, 'V', f"{level}{'_' if level else ''}{index}.mp4")
        elif inner_msg.type == MessageType.File:
            inner_msg.path = os.path.join(
                'msg', 'attach',wxid_md5,month,
                'Rec', dir0, 'F', f"{level}{'_' if level else ''}{index}", 
                inner_msg.file_name)
        elif inner_msg.type == MessageType.MergedMessages:
            parser_merged(
                inner_msg.messages, 
                f'{index}' if not level else f'{level}_{index}'
            )

parser_merged(msg.messages, '')
```

**Python**

------

### 6.2 ä¼šè¯çª—å£ session

session.db å­˜å‚¨äº†å¾®ä¿¡èŠå¤©ç•Œé¢æ˜¾ç¤ºçš„ä¼šè¯çª—å£ä¿¡æ¯

```vbnet
sql
CREATE TABLE SessionTable(
  username TEXT PRIMARY KEY, 
  type INTEGER, 
  unread_count INTEGER, 
  unread_first_msg_srv_id INTEGER, 
  is_hidden INTEGER, 
  summary TEXT, 
  draft TEXT, 
  status INTEGER, 
  last_timestamp INTEGER, 
  sort_timestamp INTEGER, 
  last_clear_unread_timestamp INTEGER, 
  last_msg_locald_id INTEGER, 
  last_msg_type INTEGER, 
  last_msg_sub_type INTEGER, 
  last_msg_sender TEXT, 
  last_sender_display_name TEXT, 
  last_msg_ext_type INTEGER
)
```

**VB.Net**

### 6.3 è¡¨æƒ…åŒ… emoticon

emoticon.db å­˜å‚¨äº†ç”¨æˆ·æ”¶è—çš„è¡¨æƒ…åŒ…ä¿¡æ¯

```vbnet
sql
CREATE TABLE kNonStoreEmoticonTable(
  type INTEGER, 
  md5 TEXT, 
  caption TEXT, 
  product_id TEXT, 
  aes_key TEXT, 
  thumb_url TEXT, 
  tp_url TEXT, 
  auth_key TEXT, 
  cdn_url TEXT, 
  extern_url TEXT, 
  extern_md5 TEXT, 
  encrypt_url TEXT
)
```

**VB.Net**

| åç§°        | ç±»å‹    | è¯´æ˜                                   |
| ----------- | ------- | -------------------------------------- |
| type        | INTEGER |                                        |
| md5         | TEXT    | è¡¨æƒ…åŒ…çš„md5ï¼Œå¯ä»¥ä»messageæ•°æ®åº“é‡Œè·å– |
| caption     | TEXT    |                                        |
| product_id  | TEXT    |                                        |
| aes_key     | TEXT    |                                        |
| thumb_url   | TEXT    | è¡¨æƒ…åŒ…ç¼©ç•¥å›¾urlï¼ˆå¯ä»¥ç›´æ¥å¼•ç”¨ï¼‰        |
| cdn_url     | TEXT    | è¡¨æƒ…åŒ…urlï¼ˆå¯ä»¥ç›´æ¥å¼•ç”¨ï¼‰              |
| extern_url  | TEXT    |                                        |
| extern_md5  | TEXT    |                                        |
| encrypt_url | TEXT    |                                        |

------

### 6.4 æœ‹å‹åœˆ sns

**SnsTimeLine è¡¨å­˜å‚¨äº†æ¯æ¡æœ‹å‹åœˆçš„è¯¦ç»†ä¿¡æ¯**

```sql
sql
CREATE TABLE SnsTimeLine(
  tid INTEGER PRIMARY KEY DESC, 
  user_name TEXT, 
  content TEXT
)
```